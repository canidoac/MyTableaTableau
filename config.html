<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SuperTables - Configuraci√≥n</title>
    <script src="https://cdn.jsdelivr.net/gh/tableau/extensions-api/lib/tableau.extensions.1.latest.min.js"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
    <link rel="stylesheet" href="config.css" />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        background: #f8f9fa;
        color: #333;
        overflow: hidden;
      }

      /* Prevent context menu (right-click) */
      body {
        -webkit-user-select: none;
        user-select: none;
      }
      
      input, textarea {
        -webkit-user-select: text;
        user-select: text;
      }

      html, body {
        margin: 0;
        padding: 0;
        width: 100%;
        height: 100%;
      }

      .config-container {
        display: flex;
        flex-direction: column;
        height: 100vh;
        overflow: hidden;
      }

      /* Fixed header styles */
      .config-header {
        background: white;
        border-bottom: 1px solid #e0e0e0;
        padding: 16px 24px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-shrink: 0;
      }

      .config-header h1 {
        font-size: 18px;
        color: #1a1a1a;
        font-weight: 600;
        margin: 0;
      }

      .header-actions {
        display: flex;
        gap: 10px;
      }

      /* Config content area with proper flex */
      .config-content {
        display: flex;
        flex-direction: column;
        flex: 1;
        overflow: hidden;
      }

      /* Horizontal tabs navigation */
      .tabs {
        display: flex;
        gap: 0;
        background: white;
        border-bottom: 2px solid #e0e0e0;
        padding: 0 24px;
        flex-shrink: 0;
      }

      .tab-btn {
        padding: 12px 20px;
        background: none;
        border: none;
        border-bottom: 3px solid transparent;
        cursor: pointer;
        font-size: 13px;
        font-weight: 500;
        color: #666;
        transition: all 0.2s;
        margin-bottom: -2px;
        position: relative;
      }

      .tab-btn:hover {
        color: #0066cc;
        background: #f8f9fa;
      }

      .tab-btn.active {
        color: #0066cc;
        border-bottom-color: #0066cc;
        background: transparent;
      }

      /* Tab panels container */
      .tab-panels {
        flex: 1;
        overflow-y: auto;
        background: #f8f9fa;
      }

      .tab-content {
        display: none;
        height: 100%;
      }

      .tab-content.active {
        display: flex;
        flex-direction: column;
      }

      /* New compact data layout with better spacing */
      .data-layout {
        display: flex;
        flex: 1;
        overflow: hidden;
        height: 100%;
      }

      .column-sidebar {
        width: 260px;
        background: white;
        border-right: 1px solid #e0e0e0;
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      .sidebar-header {
        padding: 16px;
        border-bottom: 1px solid #e0e0e0;
        background: #fafafa;
      }

      .search-reload-group {
        display: flex;
        gap: 8px;
        align-items: center;
      }

      .search-box {
        flex: 1;
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 13px;
      }

      .reload-btn {
        padding: 8px 12px;
        background: #2563eb;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 13px;
        white-space: nowrap;
        transition: background 0.2s;
      }

      .reload-btn:hover {
        background: #1d4ed8;
      }

      .column-list {
        flex: 1;
        padding: 12px;
        overflow-y: auto;
      }

      .column-section h3 {
        font-size: 11px;
        font-weight: 600;
        color: #666;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 8px;
        padding: 0 8px;
      }

      .column-item {
        padding: 8px 12px;
        margin-bottom: 2px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 13px;
        color: #333;
        transition: all 0.15s;
      }

      .column-item:hover {
        background-color: #f0f7ff;
      }

      .column-item.selected {
        background-color: #f2dc49;
        color: #1a1a1a;
        font-weight: 600;
      }

      .column-config-panel {
        flex: 1;
        background: white;
        padding: 24px;
        overflow-y: auto;
      }

      .empty-state {
        display: flex;
        align-items: center;
        justify-content: center;
        height: 100%;
        color: #999;
        font-size: 14px;
        font-style: italic;
      }

      /* Redesigned accordion-style sections */
      .config-section {
        border: 1px solid #e5e7eb;
        border-radius: 6px;
        margin-bottom: 12px;
        background: white;
        overflow: hidden;
      }

      .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 16px;
        background: #f9fafb;
        cursor: pointer;
        user-select: none;
        transition: background 0.2s;
      }

      .section-header:hover {
        background: #f3f4f6;
      }

      .section-header h4 {
        font-size: 14px;
        font-weight: 600;
        color: #374151;
        margin: 0;
      }

      .section-toggle {
        font-size: 18px;
        color: #6b7280;
        transition: transform 0.2s;
      }

      .section-header.collapsed .section-toggle {
        transform: rotate(-90deg);
      }

      .section-content {
        padding: 16px;
        border-top: 1px solid #e5e7eb;
        display: none;
      }

      .section-content.expanded {
        display: block;
      }

      /* Compact horizontal form layout */
      .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
        margin-bottom: 12px;
      }

      .form-row.single {
        grid-template-columns: 1fr;
      }

      .form-group {
        margin-bottom: 0;
      }

      .form-group label {
        display: block;
        margin-bottom: 6px;
        font-weight: 500;
        color: #374151;
        font-size: 12px;
      }

      .form-group input[type="text"],
      .form-group input[type="number"],
      .form-group select {
        width: 100%;
        padding: 8px 10px;
        border: 1px solid #d1d5db;
        border-radius: 4px;
        font-size: 13px;
        transition: border-color 0.2s;
      }

      .form-group input:focus,
      .form-group select:focus {
        outline: none;
        border-color: #2563eb;
      }

      .form-group input[type="color"] {
        width: 50px;
        height: 32px;
        border: 1px solid #d1d5db;
        border-radius: 4px;
        cursor: pointer;
        padding: 2px;
      }

      .checkbox-group {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 6px 0;
      }

      .checkbox-group input[type="checkbox"] {
        width: 16px;
        height: 16px;
        cursor: pointer;
      }

      .checkbox-group label {
        margin: 0;
        cursor: pointer;
        font-size: 13px;
        font-weight: 400;
        color: #374151;
      }

      /* Compact conditional formatting rules */
      .conditional-rule {
        background: #ffffff;
        border: 1px solid #e5e7eb;
        border-radius: 6px;
        padding: 12px;
        margin-bottom: 12px;
      }

      .rule-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
        padding-bottom: 8px;
        border-bottom: 1px solid #f3f4f6;
      }

      .rule-title {
        font-weight: 600;
        font-size: 13px;
        color: #374151;
      }

      .delete-rule-btn {
        padding: 4px 12px;
        background: #ef4444;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 11px;
        font-weight: 500;
      }

      .delete-rule-btn:hover {
        background: #dc2626;
      }

      /* Horizontal layout for rule conditions */
      .rule-condition-grid {
        display: grid;
        grid-template-columns: 140px 1fr 1fr;
        gap: 10px;
        margin-bottom: 12px;
      }

      .rule-condition-grid.with-between {
        grid-template-columns: 140px 1fr 1fr;
      }

      .rule-input-group {
        display: flex;
        flex-direction: column;
        gap: 4px;
      }

      .rule-input-group label {
        font-size: 11px;
        color: #6b7280;
        font-weight: 500;
      }

      .rule-input-group select,
      .rule-input-group input {
        padding: 6px 8px;
        border: 1px solid #d1d5db;
        border-radius: 4px;
        font-size: 12px;
      }

      .rule-condition-row {
        display: grid;
        grid-template-columns: 1fr 1.2fr;
        gap: 10px;
        margin-bottom: 12px;
      }

      .rule-formatting-row {
        display: grid;
        grid-template-columns: auto 1fr repeat(3, auto);
        gap: 8px;
        align-items: center;
        padding: 8px;
        background: #f9fafb;
        border-radius: 4px;
      }

      .rule-formatting-row label {
        font-size: 11px;
        font-weight: 500;
        color: #374151;
      }

      .rule-formatting-row select {
        padding: 5px 8px;
        border: 1px solid #d1d5db;
        border-radius: 4px;
        font-size: 11px;
        min-width: 100px;
      }

      .rule-formatting-row input[type="color"] {
        width: 36px;
        height: 28px;
        border: 1px solid #d1d5db;
        border-radius: 4px;
        cursor: pointer;
      }

      .rule-formatting-row input[type="checkbox"] {
        width: 16px;
        height: 16px;
        cursor: pointer;
      }

      /* Compact grid for formatting options */
      .rule-formatting-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 8px;
        padding-top: 12px;
        border-top: 1px solid #e5e7eb;
      }

      .format-option {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 12px;
      }

      .format-option input[type="checkbox"] {
        width: 14px;
        height: 14px;
      }

      .format-option input[type="color"] {
        width: 32px;
        height: 24px;
        border: 1px solid #d1d5db;
        border-radius: 3px;
        cursor: pointer;
        padding: 1px;
      }

      .format-option select {
        padding: 4px 6px;
        border: 1px solid #d1d5db;
        border-radius: 3px;
        font-size: 11px;
      }

      .format-option label {
        font-size: 11px;
        color: #6b7280;
        cursor: pointer;
        margin: 0;
      }

      /* Buttons */
      .btn {
        padding: 8px 16px;
        border: none;
        border-radius: 5px;
        font-size: 13px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
      }

      .btn-primary {
        background: #28a745;
        color: white;
      }

      .btn-primary:hover {
        background: #218838;
      }

      .btn-secondary {
        background: #dc3545;
        color: white;
      }

      .btn-secondary:hover {
        background: #c82333;
      }

      .btn-success {
        background: #2563eb;
        color: white;
        width: 100%;
        padding: 10px;
        margin-top: 12px;
      }

      .btn-success:hover {
        background: #1d4ed8;
      }

      .add-rule-btn {
        width: 100%;
        padding: 10px;
        background: #10b981;
        color: white;
        border: none;
        border-radius: 5px;
        font-size: 13px;
        font-weight: 500;
        cursor: pointer;
        transition: background 0.2s;
        margin-top: 8px;
      }

      .add-rule-btn:hover {
        background: #059669;
      }

      /* General content section for non-data tabs */
      .content-section {
        background: white;
        padding: 24px;
        margin: 24px;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      }

      .content-section h2 {
        font-size: 18px;
        margin-bottom: 20px;
        color: #1a1a1a;
        font-weight: 600;
      }

      .content-section h3 {
        font-size: 15px;
        margin: 20px 0 12px;
        color: #374151;
        font-weight: 600;
      }

      .help-text {
        margin-top: 4px;
        font-size: 12px;
        color: #6b7280;
      }

      .section-divider {
        height: 1px;
        background: #e5e7eb;
        margin: 20px 0;
      }

      .color-preview {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .color-preview span {
        font-size: 12px;
        color: #6b7280;
        font-family: monospace;
      }

      /* Info tab specific */
      .info-grid {
        display: grid;
        gap: 12px;
        margin-top: 16px;
      }

      .info-item {
        background: #f9fafb;
        padding: 12px 16px;
        border-radius: 6px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 13px;
      }

      .info-item strong {
        color: #374151;
      }

      .status-badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 500;
      }

      .status-online {
        background: #d1fae5;
        color: #065f46;
      }

      .feature-list {
        list-style: none;
        margin-top: 16px;
        padding: 0;
      }

      .feature-list li {
        padding: 6px 0;
        padding-left: 24px;
        position: relative;
        font-size: 13px;
        color: #374151;
      }

      .feature-list li:before {
        content: '‚úì';
        position: absolute;
        left: 0;
        color: #10b981;
        font-weight: bold;
        font-size: 14px;
      }

      /* Config saved message */
      .config-saved-message {
        display: none;
        margin-top: 12px;
        padding: 10px 14px;
        background: #10b981;
        color: white;
        border-radius: 5px;
        font-size: 13px;
        font-weight: 500;
      }

      .config-saved-message.show {
        display: block;
        animation: slideIn 0.3s ease-out;
      }

      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateY(-10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* Scrollbar styling */
      ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
      }

      ::-webkit-scrollbar-track {
        background: #f1f1f1;
      }

      ::-webkit-scrollbar-thumb {
        background: #c1c1c1;
        border-radius: 4px;
      }

      ::-webkit-scrollbar-thumb:hover {
        background: #a1a1a1;
      }

      /* CHANGE: Added styles for priorities tab */
      .priority-item {
        background: white;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        padding: 12px;
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        gap: 12px;
        cursor: move;
        transition: all 0.2s;
      }

      .priority-item:hover {
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        border-color: #2563eb;
      }

      .priority-item.dragging {
        opacity: 0.5;
      }

      .priority-number {
        background: #2563eb;
        color: white;
        width: 28px;
        height: 28px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 13px;
        flex-shrink: 0;
      }

      .priority-drag-handle {
        cursor: grab;
        color: #9ca3af;
        font-size: 18px;
        flex-shrink: 0;
      }

      .priority-drag-handle:active {
        cursor: grabbing;
      }

      .priority-info {
        flex: 1;
        min-width: 0;
      }

      .priority-column-name {
        font-weight: 600;
        font-size: 13px;
        color: #1f2937;
        margin-bottom: 4px;
      }

      .priority-rule-details {
        font-size: 11px;
        color: #6b7280;
        display: flex;
        align-items: center;
        gap: 8px;
        flex-wrap: wrap;
      }

      .priority-badge {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 2px 8px;
        border-radius: 3px;
        font-size: 11px;
        font-weight: 500;
      }

      .badge-cell {
        background: #dbeafe;
        color: #1e40af;
      }

      .badge-row {
        background: #fee2e2;
        color: #991b1b;
      }

      .priority-actions {
        display: flex;
        flex-direction: column;
        gap: 4px;
        flex-shrink: 0;
      }

      .priority-btn {
        background: #f3f4f6;
        border: 1px solid #d1d5db;
        border-radius: 4px;
        width: 28px;
        height: 28px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 14px;
        color: #4b5563;
        transition: all 0.15s;
      }

      .priority-btn:hover {
        background: #e5e7eb;
        border-color: #9ca3af;
      }

      .priority-btn:disabled {
        opacity: 0.4;
        cursor: not-allowed;
      }
    </style>
  </head>
  <body>
    <script>
      document.addEventListener('contextmenu', event => event.preventDefault());
    </script>

    <div class="config-container">
      <header class="config-header">
        <h1>SuperTables - Configuraci√≥n <span style="font-size: 13px; color: #999; font-weight: 400;">v9.0.0</span></h1>
        <div class="header-actions">
          <button id="cancel-btn" class="btn btn-secondary" onclick="closeDialog()">Cancelar</button>
          <button id="save-btn" class="btn btn-primary" onclick="saveAndClose()">Guardar y Cerrar</button>
        </div>
      </header>

      <!-- CHANGE: Changed nav structure for tabs -->
      <div class="tabs-container">
        <nav class="tabs">
          <button class="tab-btn active" onclick="switchTab('general')">General</button>
          <button class="tab-btn" onclick="switchTab('data')">Data</button>
          <button class="tab-btn" onclick="switchTab('export')">Export</button>
          <!-- Added Design tab -->
          <button class="tab-btn" onclick="switchTab('design')">Dise√±o</button>
          <!-- CHANGE: Added new Priorities tab for managing conditional format order -->
          <button class="tab-btn" onclick="switchTab('priorities')">Prioridades</button>
          <button class="tab-btn" onclick="switchTab('info')">Informaci√≥n</button>
        </nav>
      </div>

      <div class="tab-panels">
        <!-- General Tab -->
        <div id="general-tab" class="tab-content active">
          <div class="content-section">
            <h2>Configuraci√≥n General</h2>

            <div class="form-group">
              <label>Hoja de trabajo</label>
              <select id="worksheet-select">
                <option value="">La hoja se selecciona desde la extensi√≥n</option>
              </select>
              <p class="help-text">Selecciona la hoja de trabajo desde la cual se cargar√°n los datos</p>
            </div>

            <div class="section-divider"></div>

            <div class="form-group">
              <label>T√≠tulo de la tabla</label>
              <input type="text" id="table-title" placeholder="Ej: Mi Tabla de Datos" />
              <p class="help-text">Este t√≠tulo aparecer√° en la parte superior de la tabla</p>
            </div>

            <div class="section-divider"></div>

            <h3>Opciones de visualizaci√≥n</h3>
            <div class="checkbox-group">
              <input type="checkbox" id="show-search" checked />
              <label for="show-search">Mostrar buscador</label>
            </div>
            <div class="checkbox-group">
              <input type="checkbox" id="show-row-count" checked />
              <label for="show-row-count">Mostrar contador de filas</label>
            </div>
          </div>
        </div>

        <!-- Data Tab -->
        <div id="data-tab" class="tab-content">
          <div class="data-layout">
            <aside class="column-sidebar">
              <div class="sidebar-header">
                <div class="search-reload-group">
                  <input type="text" id="column-search" class="search-box" placeholder="Buscar..." />
                  <button onclick="reloadColumns()" class="reload-btn" title="Recargar columnas">‚Üª</button>
                </div>
              </div>
              <div class="column-list">
                <div class="column-section">
                  <h3>DIMENSIONES</h3>
                  <div id="dimensions-list"></div>
                </div>
                <div class="column-section" style="margin-top: 20px;">
                  <h3>MEDIDAS</h3>
                  <div id="measures-list"></div>
                </div>
              </div>
            </aside>

            <div class="column-config-panel">
              <div id="column-config-placeholder" class="empty-state">
                Selecciona una columna de la lista para configurar sus opciones
              </div>
              
              <div id="column-config-content" style="display: none;">
                <h2 id="config-column-title" style="margin-bottom: 20px; font-size: 18px;">Configurar Columna</h2>
                
                <!-- Organized config sections with accordions -->
                <div class="config-section">
                  <div class="section-header expanded" onclick="toggleSection(this)">
                    <h4>Opciones B√°sicas</h4>
                    <span class="section-toggle">‚ñº</span>
                  </div>
                  <div class="section-content expanded">
                    <div class="form-group">
                      <label>Nombre para mostrar</label>
                      <input type="text" id="column-display-name" placeholder="Nombre personalizado" />
                      <p class="help-text">Deja vac√≠o para usar el nombre original</p>
                    </div>

                    <div class="checkbox-group">
                      <input type="checkbox" id="column-visible" checked />
                      <label for="column-visible">Mostrar esta columna en la tabla</label>
                    </div>

                    <div class="checkbox-group">
                      <input type="checkbox" id="column-export" checked />
                      <label for="column-export">Incluir en exportaciones</label>
                    </div>
                  </div>
                </div>

                <!-- Conditional formatting in collapsible section -->
                <div class="config-section" id="conditional-formatting-section" style="display: none;">
                  <div class="section-header expanded" onclick="toggleSection(this)">
                    <h4>Formato Condicional</h4>
                    <span class="section-toggle">‚ñº</span>
                  </div>
                  <div class="section-content expanded">
                    <div id="conditional-rules-container">
                      <!-- Rules will be added here dynamically -->
                    </div>
                    
                    <button class="add-rule-btn" onclick="addConditionalRule()">
                      + Agregar Regla de Formato
                    </button>
                  </div>
                </div>

                <button type="button" onclick="saveColumnConfig()" class="btn btn-success">
                  Guardar Configuraci√≥n
                </button>
                
                <div id="config-saved-message" class="config-saved-message">
                  ‚úì Configuraci√≥n guardada correctamente
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Export Tab -->
        <div id="export-tab" class="tab-content">
          <div class="content-section">
            <h2>Configuraci√≥n de Exportaci√≥n</h2>

            <div class="form-group">
              <label>Nombre base del archivo</label>
              <input type="text" id="export-filename" placeholder="mi-tabla" />
              <p class="help-text">Se agregar√° la fecha autom√°ticamente al exportar</p>
            </div>

            <div class="section-divider"></div>

            <div class="form-group">
              <label>Texto del bot√≥n</label>
              <input type="text" id="export-button-text" placeholder="Exportar" />
              <p class="help-text">Personaliza el texto que aparece en el bot√≥n de exportaci√≥n</p>
            </div>

            <div class="section-divider"></div>

            <h3>Colores del bot√≥n</h3>
            <div class="form-group">
              <label>Color de fondo</label>
              <div class="color-preview">
                <input type="color" id="export-button-color" value="#2563eb" />
                <span id="export-color-value-bg">#2563eb</span>
              </div>
            </div>

            <div class="form-group">
              <label>Color del texto</label>
              <div class="color-preview">
                <input type="color" id="export-button-text-color" value="#ffffff" />
                <span id="export-color-value-text">#ffffff</span>
              </div>
            </div>

            <div class="section-divider"></div>

            <h3>Formatos disponibles</h3>
            <div class="checkbox-group">
              <input type="checkbox" id="export-enable-excel" checked />
              <label for="export-enable-excel">Habilitar exportaci√≥n a Excel (.xlsx)</label>
            </div>
            <div class="checkbox-group">
              <input type="checkbox" id="export-enable-csv" checked />
              <label for="export-enable-csv">Habilitar exportaci√≥n a CSV</label>
            </div>
            <div class="checkbox-group">
              <input type="checkbox" id="export-enable-pdf" checked />
              <label for="export-enable-pdf">Habilitar exportaci√≥n a PDF</label>
            </div>
          </div>
        </div>

        <!-- Added Design Tab -->
        <div id="design-tab" class="tab-content">
          <div class="content-section">
            <h2>Dise√±o de la Tabla</h2>
            <p class="help-text" style="margin-bottom: 20px;">Personaliza la apariencia visual de tu tabla</p>

            <div class="section-header expanded" onclick="toggleSection(this)">
              <h3>Encabezados</h3>
              <span class="section-toggle">‚ñº</span>
            </div>
            <div class="section-content expanded" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
              <div class="form-group">
                <label>Fuente</label>
                <select id="design-header-font" style="width: 100%; padding: 6px; border: 1px solid #d1d5db; border-radius: 4px;">
                  <option value="Arial, sans-serif">Arial</option>
                  <option value="'Helvetica Neue', Helvetica, sans-serif">Helvetica</option>
                  <option value="'Segoe UI', Tahoma, sans-serif">Segoe UI</option>
                  <option value="'Roboto', sans-serif">Roboto</option>
                  <option value="'Open Sans', sans-serif">Open Sans</option>
                  <option value="Georgia, serif">Georgia</option>
                  <option value="'Times New Roman', serif">Times New Roman</option>
                  <option value="'Courier New', monospace">Courier New</option>
                </select>
              </div>
              
              <div class="form-group">
                <label>Tama√±o de fuente</label>
                <select id="design-header-font-size" style="width: 100%; padding: 6px; border: 1px solid #d1d5db; border-radius: 4px;">
                  <option value="11px">11px</option>
                  <option value="12px">12px</option>
                  <option value="13px">13px</option>
                  <option value="14px" selected>14px</option>
                  <option value="15px">15px</option>
                  <option value="16px">16px</option>
                  <option value="18px">18px</option>
                </select>
              </div>
              
              <div class="form-group">
                <label>Color de fondo</label>
                <div style="display: flex; align-items: center; gap: 8px;">
                  <input type="color" id="design-header-bg" value="#f3f4f6" style="width: 50px; height: 32px; border: 1px solid #d1d5db; border-radius: 4px;">
                  <span id="design-header-bg-value" style="font-size: 12px; color: #6b7280;">#f3f4f6</span>
                </div>
              </div>
              
              <div class="form-group">
                <label>Color de texto</label>
                <div style="display: flex; align-items: center; gap: 8px;">
                  <input type="color" id="design-header-text" value="#111827" style="width: 50px; height: 32px; border: 1px solid #d1d5db; border-radius: 4px;">
                  <span id="design-header-text-value" style="font-size: 12px; color: #6b7280;">#111827</span>
                </div>
              </div>
            </div>

            <div class="section-header expanded" onclick="toggleSection(this)">
              <h3>Cuerpo de la tabla</h3>
              <span class="section-toggle">‚ñº</span>
            </div>
            <div class="section-content expanded" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
              <div class="form-group">
                <label>Fuente</label>
                <select id="design-body-font" style="width: 100%; padding: 6px; border: 1px solid #d1d5db; border-radius: 4px;">
                  <option value="Arial, sans-serif">Arial</option>
                  <option value="'Helvetica Neue', Helvetica, sans-serif">Helvetica</option>
                  <option value="'Segoe UI', Tahoma, sans-serif">Segoe UI</option>
                  <option value="'Roboto', sans-serif">Roboto</option>
                  <option value="'Open Sans', sans-serif">Open Sans</option>
                  <option value="Georgia, serif">Georgia</option>
                  <option value="'Times New Roman', serif">Times New Roman</option>
                  <option value="'Courier New', monospace">Courier New</option>
                </select>
              </div>
              
              <div class="form-group">
                <label>Tama√±o de fuente</label>
                <select id="design-body-font-size" style="width: 100%; padding: 6px; border: 1px solid #d1d5db; border-radius: 4px;">
                  <option value="11px">11px</option>
                  <option value="12px">12px</option>
                  <option value="13px" selected>13px</option>
                  <option value="14px">14px</option>
                  <option value="15px">15px</option>
                  <option value="16px">16px</option>
                </select>
              </div>
              
              <div class="form-group">
                <label>Color de texto</label>
                <div style="display: flex; align-items: center; gap: 8px;">
                  <input type="color" id="design-body-text" value="#374151" style="width: 50px; height: 32px; border: 1px solid #d1d5db; border-radius: 4px;">
                  <span id="design-body-text-value" style="font-size: 12px; color: #6b7280;">#374151</span>
                </div>
              </div>
              
              <div class="form-group">
                <label>Fondo fila par</label>
                <div style="display: flex; align-items: center; gap: 8px;">
                  <input type="color" id="design-row-even" value="#ffffff" style="width: 50px; height: 32px; border: 1px solid #d1d5db; border-radius: 4px;">
                  <span id="design-row-even-value" style="font-size: 12px; color: #6b7280;">#ffffff</span>
                </div>
              </div>
              
              <div class="form-group">
                <label>Fondo fila impar</label>
                <div style="display: flex; align-items: center; gap: 8px;">
                  <input type="color" id="design-row-odd" value="#f9fafb" style="width: 50px; height: 32px; border: 1px solid #d1d5db; border-radius: 4px;">
                  <span id="design-row-odd-value" style="font-size: 12px; color: #6b7280;">#f9fafb</span>
                </div>
              </div>
            </div>

            <div class="section-header expanded" onclick="toggleSection(this)">
              <h3>Bordes</h3>
              <span class="section-toggle">‚ñº</span>
            </div>
            <div class="section-content expanded" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
              <div class="form-group">
                <label>Color de borde</label>
                <div style="display: flex; align-items: center; gap: 8px;">
                  <input type="color" id="design-border-color" value="#e5e7eb" style="width: 50px; height: 32px; border: 1px solid #d1d5db; border-radius: 4px;">
                  <span id="design-border-color-value" style="font-size: 12px; color: #6b7280;">#e5e7eb</span>
                </div>
              </div>
              
              <div class="form-group">
                <label>Grosor de borde</label>
                <select id="design-border-width" style="width: 100%; padding: 6px; border: 1px solid #d1d5db; border-radius: 4px;">
                  <option value="0px">Sin borde</option>
                  <option value="1px" selected>1px</option>
                  <option value="2px">2px</option>
                  <option value="3px">3px</option>
                </select>
              </div>
            </div>

            <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #e5e7eb;">
              <button type="button" onclick="resetDesign()" style="padding: 8px 16px; background: #6b7280; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px;">
                Restaurar valores por defecto
              </button>
              <button type="button" onclick="saveDesignSettings()" style="padding: 8px 16px; background: #2563eb; color: white; border: none; border-radius: 4px; cursor: pointer;">
                Aplicar cambios
              </button>
            </div>
          </div>
        </div>

        <!-- Added Priorities Tab -->
        <div id="priorities-tab" class="tab-content">
          <div class="content-section">
            <h2>Prioridades de Formato Condicional</h2>
            <p class="help-text" style="margin-bottom: 20px;">
              Arrastra las reglas para reordenarlas. Las reglas en la parte superior tienen mayor prioridad.
              Los formatos de FILA siempre tienen prioridad sobre formatos de CELDA en la misma posici√≥n.
            </p>

            <div class="priority-legend" style="background: #f3f4f6; padding: 12px; border-radius: 6px; margin-bottom: 20px; font-size: 12px;">
              <strong>Leyenda:</strong>
              <span style="margin-left: 15px;">üü¶ = Celda</span>
              <span style="margin-left: 10px;">üü• = Fila</span>
              <span style="margin-left: 10px;">üé® = Color de fondo</span>
              <span style="margin-left: 10px;">üìù = Color de texto</span>
            </div>

            <div id="priorities-list-container" style="min-height: 200px;">
              <div id="priorities-empty-state" class="empty-state">
                No hay reglas de formato condicional configuradas a√∫n.
                <br><br>
                Ve a la pesta√±a "Data" y selecciona una columna para agregar reglas.
              </div>

              <div id="priorities-list" style="display: none;">
                <!-- Priority items will be generated here -->
              </div>
            </div>

            <button onclick="savePriorities()" class="btn btn-success" style="margin-top: 20px;">
              Guardar Orden de Prioridades
            </button>

            <div id="priorities-saved-message" class="config-saved-message" style="display: none;">
              ‚úì Prioridades guardadas correctamente
            </div>
          </div>
        </div>

        <!-- Information Tab -->
        <div id="info-tab" class="tab-content">
          <div class="content-section">
            <h2>Informaci√≥n de la Extensi√≥n</h2>

            <div class="info-grid">
              <div class="info-item">
                <strong>Nombre:</strong>
                <span>SuperTables Pro - MeliTable</span>
              </div>
              <div class="info-item">
                <strong>Versi√≥n:</strong>
                <span>v9.0.0</span>
              </div>
              <div class="info-item">
                <strong>Estado:</strong>
                <span class="status-badge status-online">‚óè Online</span>
              </div>
              <div class="info-item">
                <strong>Descripci√≥n:</strong>
                <span>Extensi√≥n de tabla mejorada para Tableau con exportaci√≥n, b√∫squeda, configuraci√≥n avanzada de columnas y formato condicional</span>
              </div>
            </div>

            <div class="section-divider"></div>

            <h3>Caracter√≠sticas:</h3>
            <ul class="feature-list">
              <li>Exportaci√≥n a Excel, CSV y PDF con nombres personalizables</li>
              <li>B√∫squeda y filtrado en tiempo real</li>
              <li>Configuraci√≥n personalizada de columnas</li>
              <li>Nombres de visualizaci√≥n personalizables</li>
              <li>Formato condicional con iconos y colores</li>
              <li>Control de inclusi√≥n de columnas en exportaciones</li>
              <li>Ordenamiento por columnas</li>
              <li>Paginaci√≥n configurable</li>
              <li>Google Material Icons integrados</li>
            </ul>
          </div>
        </div>
      </div>
    </div>

    <script>
      console.log("[v0] Config.html script starting...")
      
      let allColumns = []
      let currentSelectedColumn = null
      let columnsConfig = {}
      let conditionalRuleCounter = 0; // Moved counter here
      
      // CHANGE: Added priority management state
      let draggingElement = null;

      if (typeof tableau === 'undefined') {
        console.error("[v0] Tableau Extensions API not loaded!")
        alert("Error: La API de Tableau Extensions no se ha cargado correctamente.")
        // Optionally, you might want to disable further execution or provide a fallback
      }

      async function loadColumnsFromWorksheet(worksheetName) {
        console.log("[v0] Loading columns from worksheet:", worksheetName)
        
        try {
          if (!worksheetName) {
            console.warn("[v0] No worksheet name provided")
            allColumns = []
            renderColumnList()
            return
          }
          
          // Get the worksheet object
          const dashboard = tableau.extensions.dashboardContent.dashboard
          const worksheet = dashboard.worksheets.find(ws => ws.name === worksheetName)
          
          if (!worksheet) {
            console.error("[v0] Worksheet not found:", worksheetName)
            allColumns = []
            renderColumnList()
            return
          }
          
          console.log("[v0] Found worksheet, fetching data...")
          const dataTable = await worksheet.getSummaryDataAsync()
          console.log("[v0] Data received, columns:", dataTable.columns.length)
          
          // Store columns in global variable
          allColumns = dataTable.columns.map(col => ({
            fieldName: col.fieldName,
            dataType: col.dataType,
            index: col.index
          }))
          
          console.log("[v0] Columns loaded:", allColumns.length)
          
          // Also save to settings for persistence
          tableau.extensions.settings.set("dialogColumns", JSON.stringify(allColumns))
          
          // Re-render the column list
          renderColumnList()
          
        } catch (error) {
          console.error("[v0] Error loading columns:", error)
          alert("Error al cargar las columnas: " + error.message)
          allColumns = []
          renderColumnList()
        }
      }

      document.addEventListener("DOMContentLoaded", function() {
        console.log("[v0] DOM loaded, initializing Tableau Extensions...")
        
        initializeDialog(); // Changed from tableau.extensions.initializeDialogAsync()
      })

      function loadSettings() {
        console.log("[v0] Loading settings into form...")
        const settings = tableau.extensions.settings.getAll()
        
        // General tab
        document.getElementById("table-title").value = settings.tableTitle || ""
        document.getElementById("show-search").checked = settings.showSearch !== "false" && settings.showSearch !== false
        document.getElementById("show-row-count").checked = settings.showRowCount !== "false" && settings.showRowCount !== false
        
        // Export tab
        document.getElementById("export-filename").value = settings.exportFilename || "datos"
        document.getElementById("export-button-text").value = settings.exportButtonText || "Exportar"
        document.getElementById("export-button-color").value = settings.exportButtonColor || "#2563eb"
        document.getElementById("export-button-text-color").value = settings.exportButtonTextColor || "#ffffff"
        document.getElementById("export-enable-excel").checked = settings.exportEnableExcel !== "false" && settings.exportEnableExcel !== false
        document.getElementById("export-enable-csv").checked = settings.exportEnableCSV !== "false" && settings.exportEnableCSV !== false
        document.getElementById("export-enable-pdf").checked = settings.exportEnablePDF !== "false" && settings.exportEnablePDF !== false
        
        // Update color value spans
        const bgSpan = document.getElementById("export-color-value-bg");
        if (bgSpan) bgSpan.textContent = settings.exportButtonColor || "#2563eb";
        const textSpan = document.getElementById("export-color-value-text");
        if (textSpan) textSpan.textContent = settings.exportButtonTextColor || "#ffffff";

        console.log("[v0] Settings loaded successfully")
      }

      function setupEventListeners() {
        console.log("[v0] Setting up event listeners...")
        
        // Column search
        const columnSearch = document.getElementById("column-search")
        if (columnSearch) {
          columnSearch.addEventListener("input", filterColumns)
        }
        
        // Color picker updates
        document.getElementById("export-button-color").addEventListener("input", function() {
          document.getElementById("export-color-value-bg").textContent = this.value;
        });
        document.getElementById("export-button-text-color").addEventListener("input", function() {
          document.getElementById("export-color-value-text").textContent = this.value;
        });
        
        const worksheetSelect = document.getElementById("worksheet-select");
        if (worksheetSelect) {
          worksheetSelect.addEventListener("change", async function() {
            console.log("[v0] Worksheet selected:", this.value);
            tableau.extensions.settings.set("worksheet", this.value);
            
            // Load columns from the selected worksheet
            await loadColumnsFromWorksheet(this.value);
          });
        }

        console.log("[v0] All event listeners set up")
      }

      function filterColumns() {
        const searchTerm = document.getElementById("column-search").value.toLowerCase()
        document.querySelectorAll(".column-item").forEach((item) => {
          const text = item.textContent.toLowerCase()
          item.style.display = text.includes(searchTerm) ? "block" : "none"
        })
      }

      // CHANGE: Modified switchTab to load priorities when switching to that tab
      function switchTab(tabName) {
        // Hide all tabs
        document.querySelectorAll('.tab-content').forEach(tab => {
          tab.classList.remove('active');
        });
        
        // Remove active class from all tab buttons
        document.querySelectorAll('.tab-btn').forEach(btn => {
          btn.classList.remove('active');
        });
        
        // Show selected tab
        document.getElementById(tabName + '-tab').classList.add('active');
        
        // Add active class to clicked button
        // The `event.target` is the button that was clicked.
        // We need to ensure `event` is passed to this function or find the button differently.
        // For simplicity, let's assume the function is called with an event object or we find the button.
        const clickedButton = document.querySelector(`.tab-btn[onclick="switchTab('${tabName}')"]`);
        if (clickedButton) {
          clickedButton.classList.add('active');
        }

        // Load priorities list when switching to priorities tab
        if (tabName === 'priorities') {
          loadPrioritiesList();
        }
      }

      function renderColumnList() {
        console.log("[v0] Rendering column list, allColumns:", allColumns)
        const dimensionsList = document.getElementById("dimensions-list")
        const measuresList = document.getElementById("measures-list")

        if (!dimensionsList || !measuresList) {
          console.error("[v0] Column list containers not found")
          return
        }

        dimensionsList.innerHTML = ""
        measuresList.innerHTML = ""

        if (!allColumns || !Array.isArray(allColumns) || allColumns.length === 0) {
          console.warn("[v0] No columns to display or allColumns is not an array")
          dimensionsList.innerHTML = '<div class="empty-state">No hay dimensiones disponibles</div>'
          measuresList.innerHTML = '<div class="empty-state">No hay medidas disponibles</div>'
          return
        }

        console.log("[v0] Rendering", allColumns.length, "columns")
        
        let dimensionCount = 0
        let measureCount = 0
        
        allColumns.forEach((col) => {
          const colName = col.fieldName || col.name || col
          
          const item = document.createElement("div")
          item.className = "column-item"
          item.textContent = colName
          item.setAttribute("data-column", colName)
          
          item.addEventListener("click", function () {
            console.log("[v0] Column clicked:", colName)
            selectColumn(colName, col)
          })

          // Determine if dimension or measure
          const isDimension = col.isDimension || col.aggregation === "NONE" || col.dataType === "string"
          
          if (isDimension) {
            dimensionsList.appendChild(item)
            dimensionCount++
          } else {
            measuresList.appendChild(item)
            measureCount++
          }
        })

        console.log("[v0] Rendered", dimensionCount, "dimensions and", measureCount, "measures")
        
        if (dimensionCount === 0) {
          dimensionsList.innerHTML = '<div class="empty-state">No hay dimensiones</div>'
        }
        if (measureCount === 0) {
          measuresList.innerHTML = '<div class="empty-state">No hay medidas</div>'
        }
      }

      function selectColumn(colName, columnInfo) {
        console.log("[v0] Selecting column:", colName, columnInfo)
        currentSelectedColumn = colName

        // Update visual selection
        document.querySelectorAll(".column-item").forEach((item) => item.classList.remove("selected"))
        const selectedItem = document.querySelector(`[data-column="${colName}"]`)
        if (selectedItem) {
          selectedItem.classList.add("selected")
        }

        // Show config panel
        document.getElementById("column-config-placeholder").style.display = "none"
        document.getElementById("column-config-content").style.display = "block"

        // Load column data
        const columnData = columnsConfig[colName] || {
          visible: true,
          includeInExport: true,
        }

        document.getElementById("config-column-title").textContent = `Configurar: ${colName}`
        document.getElementById("column-display-name").value = columnData.displayName || ""
        document.getElementById("column-visible").checked = columnData.visible !== false
        document.getElementById("column-export").checked = columnData.includeInExport !== false

        // Call the modified showColumnConfig function
        showColumnConfig(colName);
      }

      // START: Updated addConditionalRule function
      function addConditionalRule(ruleData = null) {
        const ruleId = `rule-${conditionalRuleCounter++}`;
        const container = document.getElementById("conditional-rules-container");
        
        // Detect column type for correct operator/input display
        const column = allColumns.find(c => c.fieldName === currentSelectedColumn);
        const isDimension = column?.dataType === "string" || false;
        
        const ruleDiv = document.createElement("div");
        ruleDiv.className = "conditional-rule";
        ruleDiv.id = ruleId;
        
        const operatorOptions = isDimension ? `
          <option value="equals">Es igual a</option>
          <option value="notEquals">No es igual a</option>
          <option value="contains">Contiene</option>
          <option value="notContains">No contiene</option>
          <option value="startsWith">Empieza con</option>
          <option value="endsWith">Termina con</option>
          <option value="isEmpty">Est√° vac√≠o</option>
          <option value="isNotEmpty">No est√° vac√≠o</option>
        ` : `
          <option value=">=">Mayor o igual (>=)</option>
          <option value="<=">Menor o igual (<=)</option>
          <option value="=">Igual (=)</option>
          <option value=">">Mayor (>)</option>
          <option value="<">Menor (<)</option>
          <option value="!=">Diferente (!=)</option>
          <option value="between">Entre</option>
        `;

        ruleDiv.innerHTML = `
          <div class="rule-header">
            <span class="rule-title">Regla ${container.children.length + 1}</span>
            <button class="delete-rule-btn" onclick="deleteConditionalRule('${ruleId}')">Eliminar</button>
          </div>
          
          <div class="rule-condition-row">
            <div class="rule-input-group">
              <label>Operador</label>
              <select class="rule-operator">${operatorOptions}</select>
            </div>
            <div class="rule-input-group">
              <label>Valor</label>
              <input type="${isDimension ? 'text' : 'number'}" class="rule-value" placeholder="Valor">
              <input type="number" class="rule-value2" placeholder="Valor 2" style="display:none; margin-top: 4px;">
            </div>
          </div>
          
          <div class="rule-formatting-row">
            <label>Pintar</label>
            <select class="rule-paint-target">
              <option value="none">Ninguno</option>
              <option value="cell">Celda</option>
              <option value="row">Fila</option>
            </select>
            
            <label style="margin-left: 12px;">Fondo</label>
            <input type="color" class="rule-bg-color" value="#ffeb3b" title="Color de fondo">
            
            <input type="checkbox" class="rule-text-enabled" id="${ruleId}-text" title="Activar color de texto">
            <label for="${ruleId}-text" style="margin: 0;">Texto</label>
            <input type="color" class="rule-text-color" value="#000000" title="Color de texto">
            
            <input type="checkbox" class="rule-icon-enabled" id="${ruleId}-icon" title="Activar √≠cono" style="margin-left: 12px;">
            <label for="${ruleId}-icon" style="margin: 0;">√çcono</label>
            <select class="rule-icon" style="min-width: 80px;">
              <option value="">Ninguno</option>
              <option value="‚Üë">‚Üë Arriba</option>
              <option value="‚Üì">‚Üì Abajo</option>
              <option value="‚Üí">‚Üí Derecha</option>
              <option value="‚Üê">‚Üê Izquierda</option>
              <option value="‚¨§">‚¨§ C√≠rculo</option>
              <option value="‚óã">‚óã Vac√≠o</option>
              <option value="‚ñ†">‚ñ† Cuadrado</option>
              <option value="‚ñ°">‚ñ° Hueco</option>
              <option value="‚úì">‚úì Check</option>
              <option value="‚úó">‚úó X</option>
              <option value="‚ö†">‚ö† Alerta</option>
              <option value="‚òÖ">‚òÖ Estrella</option>
              <option value="‚òÜ">‚òÜ Estrella vac√≠a</option>
              <option value="‚óè">‚óè Punto</option>
              <option value="‚ñ≤">‚ñ≤ Tri√°ngulo arriba</option>
              <option value="‚ñº">‚ñº Tri√°ngulo abajo</option>
              <option value="‚óÜ">‚óÜ Diamante</option>
              <option value="‚ô•">‚ô• Coraz√≥n</option>
              <option value="üî¥">üî¥ Rojo</option>
              <option value="üü¢">üü¢ Verde</option>
              <option value="üü°">üü° Amarillo</option>
              <option value="‚ö´">‚ö´ Negro</option>
              <option value="‚ö™">‚ö™ Blanco</option>
            </select>
            <input type="color" class="rule-icon-color" value="#000000" title="Color del √≠cono">
          </div>
        `;

        container.appendChild(ruleDiv);

        const operatorSelect = ruleDiv.querySelector(".rule-operator");
        const value2Input = ruleDiv.querySelector(".rule-value2");
        operatorSelect.addEventListener("change", () => {
          value2Input.style.display = operatorSelect.value === "between" ? "block" : "none";
        });

        if (ruleData) {
          ruleDiv.querySelector(".rule-operator").value = ruleData.operator || "";
          ruleDiv.querySelector(".rule-value").value = ruleData.value || "";
          if (ruleData.value2) {
            ruleDiv.querySelector(".rule-value2").value = ruleData.value2;
            ruleDiv.querySelector(".rule-value2").style.display = "block";
          }
          
          // Determine paint target from flags
          let paintTarget = "none";
          if (ruleData.cellBg || ruleData.cellText) {
            paintTarget = "cell";
          } else if (ruleData.rowBg || ruleData.rowText) {
            paintTarget = "row";
          }
          ruleDiv.querySelector(".rule-paint-target").value = paintTarget;
          
          if (ruleData.cellBgColor || ruleData.rowBgColor) {
            ruleDiv.querySelector(".rule-bg-color").value = ruleData.cellBgColor || ruleData.rowBgColor;
          }
          
          if (ruleData.cellText || ruleData.rowText) {
            ruleDiv.querySelector(".rule-text-enabled").checked = true;
            ruleDiv.querySelector(".rule-text-color").value = ruleData.cellTextColor || ruleData.rowTextColor || "#000000";
          }
          
          if (ruleData.addIcon) {
            ruleDiv.querySelector(".rule-icon-enabled").checked = true;
            ruleDiv.querySelector(".rule-icon").value = ruleData.icon || "";
            ruleDiv.querySelector(".rule-icon-color").value = ruleData.iconColor || "#000000";
          }
        }
      }
      // END: Updated addConditionalRule function

      function showColumnConfig(columnName) {
        console.log("[v0] Showing config for column:", columnName)
        currentSelectedColumn = columnName

        const columnData = columnsConfig[columnName] || {}
        const column = allColumns.find((c) => c.fieldName === columnName)

        document.getElementById("column-display-name").value = columnData.displayName || ""
        document.getElementById("column-visible").checked = columnData.visible !== false
        document.getElementById("column-export").checked = columnData.includeInExport !== false

        const isDimension = column?.dataType === "string" || false;
        const conditionalSection = document.getElementById("conditional-formatting-section");
        
        if (conditionalSection) {
          conditionalSection.style.display = "block";
          
          const container = document.getElementById("conditional-rules-container");
          container.innerHTML = "";
          conditionalRuleCounter = 0; // Reset counter for each column
          
          if (columnData.conditionalRules && Array.isArray(columnData.conditionalRules)) {
            columnData.conditionalRules.forEach(rule => {
              addConditionalRule(rule);
            });
          } else if (columnData.conditionalFormat && columnData.conditionalFormat.enabled) {
            // Ensure only one rule is added if migrating from old format
            addConditionalRule(columnData.conditionalFormat);
          }
        }

        document.getElementById("column-config-content").style.display = "block"
        document.getElementById("column-config-placeholder").style.display = "none"
      }

      function saveColumnConfig() {
        console.log("[v0] Guardando configuraci√≥n de columna...");
        
        if (!currentSelectedColumn) {
          console.warn("[v0] No column selected");
          return;
        }

        const rulesContainer = document.getElementById("conditional-rules-container");
        const conditionalRules = [];
        
        rulesContainer.querySelectorAll(".conditional-rule").forEach((ruleDiv) => {
          const operator = ruleDiv.querySelector(".rule-operator").value;
          const value = ruleDiv.querySelector(".rule-value").value;
          const value2 = ruleDiv.querySelector(".rule-value2").value;
          const paintTarget = ruleDiv.querySelector(".rule-paint-target").value;
          const bgColor = ruleDiv.querySelector(".rule-bg-color").value;
          const textEnabled = ruleDiv.querySelector(".rule-text-enabled").checked;
          const textColor = ruleDiv.querySelector(".rule-text-color").value;
          const iconEnabled = ruleDiv.querySelector(".rule-icon-enabled").checked;
          const icon = ruleDiv.querySelector(".rule-icon").value;
          const iconColor = ruleDiv.querySelector(".rule-icon-color").value;
          
          const rule = {
            operator,
            value,
          };
          
          if (value2) rule.value2 = value2;
          
          // Set flags based on paint target
          if (paintTarget === "cell") {
            rule.cellBg = true;
            rule.cellBgColor = bgColor;
            if (textEnabled) {
              rule.cellText = true;
              rule.cellTextColor = textColor;
            }
          } else if (paintTarget === "row") {
            rule.rowBg = true;
            rule.rowBgColor = bgColor;
            if (textEnabled) {
              rule.rowText = true;
              rule.rowTextColor = textColor;
            }
          }
          
          if (iconEnabled && icon) {
            rule.addIcon = true;
            rule.icon = icon;
            rule.iconColor = iconColor;
          }
          
          conditionalRules.push(rule);
        });

        console.log("[v0] Conditional rules collected:", conditionalRules);

        const columnData = {
          displayName: document.getElementById("column-display-name").value,
          visible: document.getElementById("column-visible").checked,
          export: document.getElementById("column-export").checked,
          conditionalRules: conditionalRules
        };

        console.log("[v0] Guardando configuraci√≥n de columna:", currentSelectedColumn, columnData);

        // Get existing config
        const existingConfigStr = tableau.extensions.settings.get("columnsConfig");
        const columnsConfig = existingConfigStr ? JSON.parse(existingConfigStr) : {};
        
        // Update column config
        columnsConfig[currentSelectedColumn] = columnData;
        
        console.log("[v0] Config actualizado:", columnsConfig);

        // Save to settings
        tableau.extensions.settings.set("columnsConfig", JSON.stringify(columnsConfig));
        
        // Save settings
        tableau.extensions.settings.saveAsync().then(() => {
          console.log("[v0] Config guardado exitosamente");
          
          // Reload config in memory
          const reloadedStr = tableau.extensions.settings.get("columnsConfig");
          if (reloadedStr) {
            Object.assign(columnsConfig, JSON.parse(reloadedStr));
          }
          console.log("[v0] Config recargado en memoria:", columnsConfig);
        }).catch((error) => {
          console.error("[v0] Error al guardar config:", error);
        });
      }
      
      function reloadColumns() {
        console.log("[v0] Reloading columns...")
        const worksheetSelector = document.getElementById("worksheet-select")
        if (worksheetSelector && worksheetSelector.value) {
          loadColumnsFromWorksheet(worksheetSelector.value)
        } else {
          console.log("[v0] No worksheet selected, cannot reload columns")
        }
      }

      function autoSave() {
        console.log("[v0] === AUTOSAVE INICIADO ===")
        
        try {
          // General settings
          const tableTitle = document.getElementById("table-title").value || "";
          const showSearch = document.getElementById("show-search").checked;
          const showRowCount = document.getElementById("show-row-count").checked;
          
          console.log("[v0] General Settings:");
          console.log("[v0]   - Table Title:", tableTitle);
          console.log("[v0]   - Show Search:", showSearch);
          console.log("[v0]   - Show Row Count:", showRowCount);
          
          tableau.extensions.settings.set("tableTitle", tableTitle);
          tableau.extensions.settings.set("showSearch", showSearch ? "true" : "false");
          tableau.extensions.settings.set("showRowCount", showRowCount ? "true" : "false");
          
          // Export settings
          const exportButtonText = document.getElementById("export-button-text").value || "Exportar";
          const exportFilename = document.getElementById("export-filename").value || "datos";
          const exportButtonColor = document.getElementById("export-button-color").value || "#2563eb";
          const exportButtonTextColor = document.getElementById("export-button-text-color").value || "#ffffff";
          const exportEnableExcel = document.getElementById("export-enable-excel").checked;
          const exportEnableCSV = document.getElementById("export-enable-csv").checked;
          const exportEnablePDF = document.getElementById("export-enable-pdf").checked;
          
          console.log("[v0] Export Settings:");
          console.log("[v0]   - Button Text:", exportButtonText);
          console.log("[v0]   - Filename:", exportFilename);
          console.log("[v0]   - Excel enabled:", exportEnableExcel);
          
          tableau.extensions.settings.set("exportButtonText", exportButtonText);
          tableau.extensions.settings.set("exportFilename", exportFilename);
          tableau.extensions.settings.set("exportButtonColor", exportButtonColor);
          tableau.extensions.settings.set("exportButtonTextColor", exportButtonTextColor);
          tableau.extensions.settings.set("exportEnableExcel", exportEnableExcel ? "true" : "false");
          tableau.extensions.settings.set("exportEnableCSV", exportEnableCSV ? "true" : "false");
          tableau.extensions.settings.set("exportEnablePDF", exportEnablePDF ? "true" : "false");
          
          const currentColumnsConfig = tableau.extensions.settings.get("columnsConfig");
          console.log("[v0] Current columnsConfig in settings:");
          if (currentColumnsConfig) {
            try {
              const parsed = JSON.parse(currentColumnsConfig);
              console.log("[v0]   - Columns:", Object.keys(parsed).length);
              Object.keys(parsed).forEach(colName => {
                if (parsed[colName].conditionalRules && parsed[colName].conditionalRules.length > 0) {
                  console.log(`[v0]   - ${colName}: ${parsed[colName].conditionalRules.length} rules`);
                }
              });
            } catch (e) {
              console.error("[v0] Error parsing columnsConfig:", e);
            }
          } else {
            console.log("[v0]   - No columnsConfig found");
          }
          
          console.log("[v0] All settings prepared, calling saveAsync...")
          return tableau.extensions.settings.saveAsync().then(() => {
            console.log("[v0] ‚úì ‚úì ‚úì SaveAsync completed successfully");
          });
        } catch (error) {
          console.error("[v0] ‚úó ‚úó ‚úó Error in autoSave:", error);
          return Promise.reject(error);
        }
      }

      function saveAndClose() {
        console.log("[v0] === SAVE AND CLOSE INICIADO ===")
        
        if (typeof tableau === 'undefined' || !tableau.extensions) {
          console.error("[v0] ‚úó Tableau Extensions not initialized")
          alert("Error: La extensi√≥n de Tableau no est√° inicializada correctamente.")
          return
        }
        
        autoSave()
          .then(() => {
            console.log("[v0] ‚úì Settings saved successfully")
            console.log("[v0] Closing dialog with payload: 'saved'")
            tableau.extensions.ui.closeDialog("saved")
          })
          .catch((error) => {
            console.error("[v0] ‚úó Error saving settings:", error)
            alert("Error al guardar la configuraci√≥n: " + error.message)
          })
      }

      function closeDialog() {
        console.log("[v0] CloseDialog called without saving")
        
        if (typeof tableau === 'undefined' || !tableau.extensions) {
          console.error("[v0] Tableau Extensions not initialized")
          window.close()
          return
        }
        
        tableau.extensions.ui.closeDialog("cancelled")
      }

      function populateWorksheetSelector() {
        console.log("[v0] Populating worksheet selector...")
        
        const worksheetSelect = document.getElementById("worksheet-select")
        if (!worksheetSelect) {
          console.error("[v0] Worksheet select element not found")
          return
        }
        
        // Get dashboard from parent window
        if (typeof tableau !== 'undefined' && tableau.extensions && tableau.extensions.dashboardContent) {
          const dashboard = tableau.extensions.dashboardContent.dashboard
          const worksheets = dashboard.worksheets
          
          console.log("[v0] Found worksheets:", worksheets.map(w => w.name))
          
          // Clear existing options except placeholder
          worksheetSelect.innerHTML = '<option value="">La hoja se selecciona desde la extensi√≥n</option>'
          
          // Add worksheet options
          worksheets.forEach(ws => {
            const option = document.createElement("option")
            option.value = ws.name
            option.textContent = ws.name
            worksheetSelect.appendChild(option)
          })
          
          // Set current selection
          const currentWorksheet = tableau.extensions.settings.get("worksheet")
          if (currentWorksheet) {
            worksheetSelect.value = currentWorksheet
          }
        } else {
          console.warn("[v0] Tableau dashboard content not available for worksheet selection.")
        }
      }

      // Function to toggle accordion sections
      function toggleSection(element) {
        const sectionHeader = element;
        const sectionContent = sectionHeader.nextElementSibling;
        const sectionToggle = sectionHeader.querySelector('.section-toggle');

        sectionHeader.classList.toggle('collapsed');
        sectionContent.classList.toggle('expanded');
        
        if (sectionContent.classList.contains('expanded')) {
            sectionToggle.textContent = '‚ñº'; // Expanded state
        } else {
            sectionToggle.textContent = '‚ñ∂'; // Collapsed state
        }
      }

      function saveDesignSettings() {
        console.log('[v0] Saving design settings')
        
        const settings = {
          headerBackgroundColor: document.getElementById('design-header-bg').value,
          headerTextColor: document.getElementById('design-header-text').value,
          headerFont: document.getElementById('design-header-font').value,
          headerFontSize: document.getElementById('design-header-font-size').value,
          bodyFont: document.getElementById('design-body-font').value,
          bodyFontSize: document.getElementById('design-body-font-size').value,
          bodyTextColor: document.getElementById('design-body-text').value,
          rowEvenColor: document.getElementById('design-row-even').value,
          rowOddColor: document.getElementById('design-row-odd').value,
          borderColor: document.getElementById('design-border-color').value,
          borderWidth: document.getElementById('design-border-width').value
        }
        
        Object.entries(settings).forEach(([key, value]) => {
          tableau.extensions.settings.set(key, value)
        })
        
        tableau.extensions.settings.saveAsync().then(() => {
          alert('Configuraci√≥n de dise√±o guardada correctamente')
          console.log('[v0] Design settings saved')
        })
      }
      
      function resetDesign() {
        document.getElementById('design-header-bg').value = '#f3f4f6'
        document.getElementById('design-header-text').value = '#111827'
        document.getElementById('design-header-font').value = 'Arial, sans-serif'
        document.getElementById('design-header-font-size').value = '14px'
        document.getElementById('design-body-font').value = 'Arial, sans-serif'
        document.getElementById('design-body-font-size').value = '13px'
        document.getElementById('design-body-text').value = '#374151'
        document.getElementById('design-row-even').value = '#ffffff'
        document.getElementById('design-row-odd').value = '#f9fafb'
        document.getElementById('design-border-color').value = '#e5e7eb'
        document.getElementById('design-border-width').value = '1px'
        
        updateColorDisplays()
      }
      
      function updateColorDisplays() {
        document.getElementById('design-header-bg-value').textContent = document.getElementById('design-header-bg').value
        document.getElementById('design-header-text-value').textContent = document.getElementById('design-header-text').value
        document.getElementById('design-body-text-value').textContent = document.getElementById('design-body-text').value
        document.getElementById('design-row-even-value').textContent = document.getElementById('design-row-even').value
        document.getElementById('design-row-odd-value').textContent = document.getElementById('design-row-odd').value
        document.getElementById('design-border-color-value').textContent = document.getElementById('design-border-color').value
      }
      
      function loadDesignSettings() {
        const settings = tableau.extensions.settings.getAll()
        
        if (settings.headerBackgroundColor) document.getElementById('design-header-bg').value = settings.headerBackgroundColor
        if (settings.headerTextColor) document.getElementById('design-header-text').value = settings.headerTextColor
        if (settings.headerFont) document.getElementById('design-header-font').value = settings.headerFont
        if (settings.headerFontSize) document.getElementById('design-header-font-size').value = settings.headerFontSize
        if (settings.bodyFont) document.getElementById('design-body-font').value = settings.bodyFont
        if (settings.bodyFontSize) document.getElementById('design-body-font-size').value = settings.bodyFontSize
        if (settings.bodyTextColor) document.getElementById('design-body-text').value = settings.bodyTextColor
        if (settings.rowEvenColor) document.getElementById('design-row-even').value = settings.rowEvenColor
        if (settings.rowOddColor) document.getElementById('design-row-odd').value = settings.rowOddColor
        if (settings.borderColor) document.getElementById('design-border-color').value = settings.borderColor
        if (settings.borderWidth) document.getElementById('design-border-width').value = settings.borderWidth
        
        updateColorDisplays()
      }
      
      // Add event listeners for color pickers
      document.addEventListener('DOMContentLoaded', () => {
        const colorInputs = [
          'design-header-bg',
          'design-header-text',
          'design-body-text',
          'design-row-even',
          'design-row-odd',
          'design-border-color'
        ]
        
        colorInputs.forEach(id => {
          const input = document.getElementById(id)
          if (input) {
            input.addEventListener('input', updateColorDisplays)
          }
        })
      })

      // This function should be called once the DOM is ready and Tableau Extensions are initialized.
      // It replaces the direct call to initializeDialogAsync inside DOMContentLoaded.
      async function initializeDialog() {
        console.log("[v0] Inicializando di√°logo de configuraci√≥n")
        try {
          await tableau.extensions.initializeDialogAsync()
          console.log("[v0] Di√°logo inicializado")

          const settings = tableau.extensions.settings.getAll()
          console.log("[v0] Settings actuales:", settings)
          
          populateWorksheetSelector()
          
          // Load columns from settings
          if (settings.dialogColumns) {
            try {
              const parsed = JSON.parse(settings.dialogColumns)
              // Ensure it's an array
              if (Array.isArray(parsed)) {
                allColumns = parsed
              } else {
                console.warn("[v0] dialogColumns is not an array, resetting to empty array")
                allColumns = []
              }
              console.log("[v0] Loaded columns from settings:", allColumns)
            } catch (e) {
              console.error("[v0] Error parsing dialogColumns:", e)
              allColumns = []
            }
          } else {
            console.warn("[v0] No dialogColumns found in settings")
            allColumns = []
          }
          
          // Load existing columnsConfig
          if (settings.columnsConfig) {
            try {
              columnsConfig = JSON.parse(settings.columnsConfig)
              console.log("[v0] Loaded columnsConfig:", columnsConfig)
            } catch (e) {
              console.error("[v0] Error parsing columnsConfig:", e)
              columnsConfig = {}
            }
          }
          
          loadSettings()
          setupEventListeners()
          renderColumnList()
          
          loadDesignSettings()

          console.log("[v0] Inicializaci√≥n completada")
        } catch (error) {
          console.error("[v0] Error al inicializar:", error)
          alert("Error al inicializar: " + error.message)
        }
      }

      // CHANGE: Added priority management functions
      
      function loadPrioritiesList() {
        console.log('[v0] Loading priorities list...');
        const container = document.getElementById('priorities-list');
        const emptyState = document.getElementById('priorities-empty-state');
        
        // Get all conditional rules from all columns
        const allRules = [];
        Object.keys(columnsConfig).forEach(fieldName => {
          const colConfig = columnsConfig[fieldName];
          if (colConfig.conditionalRules && Array.isArray(colConfig.conditionalRules)) {
            colConfig.conditionalRules.forEach((rule, index) => {
              allRules.push({
                columnName: colConfig.displayName || fieldName,
                fieldName: fieldName,
                ruleIndex: index,
                rule: rule,
                priority: rule.priority || 999
              });
            });
          }
        });

        console.log('[v0] Found rules:', allRules);

        if (allRules.length === 0) {
          container.style.display = 'none';
          emptyState.style.display = 'block';
          return;
        }

        // Sort by priority
        allRules.sort((a, b) => a.priority - b.priority);

        // Generate HTML
        container.innerHTML = allRules.map((item, index) => {
          const rule = item.rule;
          const paintType = rule.paintTarget === 'row' ? 'Fila' : rule.paintTarget === 'cell' ? 'Celda' : 'Ninguno';
          const paintBadge = rule.paintTarget === 'row' ? 
            '<span class="priority-badge badge-row">üü• Fila</span>' : 
            '<span class="priority-badge badge-cell">üü¶ Celda</span>';
          
          let formatDetails = [];
          if (rule.cellBg || rule.rowBg) formatDetails.push('üé® Fondo');
          if (rule.cellText || rule.rowText) formatDetails.push('üìù Texto');
          if (rule.icon && rule.icon !== 'none' && rule.icon !== '') formatDetails.push('üî∂ Icono');

          return `
            <div class="priority-item" draggable="true" data-field="${item.fieldName}" data-rule-index="${item.ruleIndex}">
              <span class="priority-drag-handle">‚ãÆ‚ãÆ</span>
              <div class="priority-number">${index + 1}</div>
              <div class="priority-info">
                <div class="priority-column-name">${item.columnName}</div>
                <div class="priority-rule-details">
                  ${paintBadge}
                  <span>${rule.operator} "${rule.value}"</span>
                  ${formatDetails.length > 0 ? '<span>‚Üí</span>' : ''}
                  ${formatDetails.join(' ')}
                </div>
              </div>
              <div class="priority-actions">
                <button class="priority-btn" onclick="movePriorityUp(${index})" ${index === 0 ? 'disabled' : ''} title="Mover arriba">‚ñ≤</button>
                <button class="priority-btn" onclick="movePriorityDown(${index})" ${index === allRules.length - 1 ? 'disabled' : ''} title="Mover abajo">‚ñº</button>
              </div>
            </div>
          `;
        }).join('');

        container.style.display = 'block';
        emptyState.style.display = 'none';

        // Setup drag and drop
        setupDragAndDrop();
      }

      function setupDragAndDrop() {
        const items = document.querySelectorAll('.priority-item');
        
        items.forEach(item => {
          item.addEventListener('dragstart', function() {
            draggingElement = this;
            this.classList.add('dragging');
            // Optional: Set dataTransfer data if needed for more complex scenarios
            // event.dataTransfer.setData('text/plain', this.id);
          });

          item.addEventListener('dragend', function() {
            this.classList.remove('dragging');
            draggingElement = null;
          });
        });

        const container = document.getElementById('priorities-list');
        container.addEventListener('dragover', function(e) {
          e.preventDefault(); // Necessary to allow dropping
          if (draggingElement) {
            const afterElement = getDragAfterElement(container, e.clientY);
            if (afterElement == null) {
              container.appendChild(draggingElement);
            } else {
              container.insertBefore(draggingElement, afterElement);
            }
            updatePriorityNumbers();
          }
        });
      }

      function getDragAfterElement(container, y) {
        const draggableElements = [...container.querySelectorAll('.priority-item:not(.dragging)')];

        return draggableElements.reduce((closest, child) => {
          const box = child.getBoundingClientRect();
          const offset = y - box.top - box.height / 2;
          if (offset < 0 && offset > closest.offset) {
            return { offset: offset, element: child };
          } else {
            return closest;
          }
        }, { offset: Number.NEGATIVE_INFINITY }).element;
      }

      function updatePriorityNumbers() {
        const items = document.querySelectorAll('.priority-item');
        items.forEach((item, index) => {
          const numberEl = item.querySelector('.priority-number');
          if (numberEl) numberEl.textContent = index + 1;

          const upBtn = item.querySelector('.priority-btn:first-child');
          const downBtn = item.querySelector('.priority-btn:last-child');
          if (upBtn) upBtn.disabled = index === 0;
          if (downBtn) downBtn.disabled = index === items.length - 1;
        });
      }

      function movePriorityUp(index) {
        const container = document.getElementById('priorities-list');
        const items = container.querySelectorAll('.priority-item');
        if (index > 0) {
          container.insertBefore(items[index], items[index - 1]);
          updatePriorityNumbers();
        }
      }

      function movePriorityDown(index) {
        const container = document.getElementById('priorities-list');
        const items = container.querySelectorAll('.priority-item');
        if (index < items.length - 1) {
          container.insertBefore(items[index + 1], items[index]);
          updatePriorityNumbers();
        }
      }

      async function savePriorities() {
        console.log('[v0] Saving priorities...');
        const items = document.querySelectorAll('.priority-item');
        
        // Update priority values in columnsConfig
        items.forEach((item, priority) => {
          const fieldName = item.dataset.field;
          const ruleIndex = parseInt(item.dataset.ruleIndex);
          
          if (columnsConfig[fieldName] && columnsConfig[fieldName].conditionalRules) {
            const rule = columnsConfig[fieldName].conditionalRules[ruleIndex];
            if (rule) {
              rule.priority = priority;
              console.log(`[v0] Set priority ${priority} for ${fieldName} rule ${ruleIndex}`);
            }
          }
        });

        // Save to settings
        tableau.extensions.settings.set('columnsConfig', JSON.stringify(columnsConfig));
        await tableau.extensions.settings.saveAsync();

        // Show confirmation
        const message = document.getElementById('priorities-saved-message');
        message.style.display = 'block';
        setTimeout(() => {
          message.style.display = 'none';
        }, 3000);

        console.log('[v0] Priorities saved successfully');
      }

      function deleteConditionalRule(ruleId) {
        const ruleElement = document.getElementById(ruleId);
        if (ruleElement) {
          ruleElement.remove();
          // Optionally, update the column config if you need to persist this deletion immediately
          // For now, it will be saved when the main save button is clicked.
          console.log(`[v0] Deleted rule element: ${ruleId}`);
        }
      }
    </script>
  </body>
</html>
