<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Configuración - SuperTables</title>
    <script src="https://cdn.jsdelivr.net/gh/tableau/extensions-api/lib/tableau.extensions.1.latest.min.js"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        background: #f8f9fa;
        color: #333;
        overflow-x: hidden;
      }

      .config-container {
        display: flex;
        flex-direction: column;
        height: 100vh;
      }

      .config-header {
        background: white;
        border-bottom: 1px solid #e0e0e0;
        padding: 16px 24px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .config-header h1 {
        font-size: 18px;
        color: #1a1a1a;
        font-weight: 600;
      }

      .header-actions {
        display: flex;
        gap: 10px;
      }

      .btn {
        padding: 8px 16px;
        border: none;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
      }

      .btn-success {
        background: #10b981;
        color: white;
      }

      .btn-success:hover {
        background: #059669;
      }

      .btn-secondary {
        background: #ef4444;
        color: white;
      }

      .btn-secondary:hover {
        background: #dc2626;
      }

      .tabs {
        display: flex;
        background: white;
        border-bottom: 2px solid #e0e0e0;
        padding: 0 24px;
      }

      .tab-btn {
        padding: 12px 20px;
        background: none;
        border: none;
        border-bottom: 3px solid transparent;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        color: #666;
        transition: all 0.2s;
        margin-bottom: -2px;
      }

      .tab-btn:hover {
        color: #333;
        background: #f8f9fa;
      }

      .tab-btn.active {
        color: #2563eb;
        border-bottom-color: #2563eb;
      }

      .config-content {
        flex: 1;
        overflow-y: auto;
        padding: 24px;
      }

      .tab-content {
        display: none;
      }

      .tab-content.active {
        display: block;
      }

      .help-text {
        color: #64748b;
        font-size: 13px;
        margin-bottom: 20px;
      }

      .formato-item {
        background: white;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        padding: 16px;
        margin-bottom: 16px;
      }

      .formato-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
      }

      .formato-name {
        font-weight: 600;
        font-size: 15px;
        color: #1e293b;
      }

      .btn-delete {
        background: none;
        border: none;
        color: #ef4444;
        cursor: pointer;
        font-size: 20px;
        padding: 4px 8px;
        border-radius: 4px;
      }

      .btn-delete:hover {
        background: #fee2e2;
      }

      .formato-config {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
        margin-top: 12px;
      }

      .form-group {
        display: flex;
        flex-direction: column;
        gap: 4px;
      }

      .form-group label {
        font-size: 12px;
        font-weight: 500;
        color: #64748b;
      }

      .form-group input[type="text"],
      .form-group select {
        padding: 8px 10px;
        border: 1px solid #e2e8f0;
        border-radius: 6px;
        font-size: 13px;
      }

      .form-group input[type="color"] {
        width: 60px;
        height: 36px;
        border: 1px solid #e2e8f0;
        border-radius: 6px;
        cursor: pointer;
      }

      .color-group {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .checkbox-group {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 0;
      }

      .checkbox-group input[type="checkbox"] {
        width: 18px;
        height: 18px;
        cursor: pointer;
      }

      .column-item {
        background: white;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        padding: 12px;
        margin-bottom: 12px;
      }

      .column-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
      }

      .column-name {
        font-weight: 600;
        font-size: 14px;
      }

      .btn-primary {
        background: #2563eb;
        color: white;
      }

      .btn-primary:hover {
        background: #1d4ed8;
      }

      .success-message {
        display: none;
        background: #dcfce7;
        color: #166534;
        padding: 12px 16px;
        border-radius: 6px;
        margin-top: 16px;
        font-size: 14px;
      }

      .success-message.show {
        display: block;
      }
    </style>
</head>
<body>
    <div class="config-container">
        <div class="config-header">
            <h1>Configuración</h1>
            <div class="header-actions">
                <button onclick="saveAndClose()" class="btn btn-success">Guardar</button>
                <button onclick="cancelAndClose()" class="btn btn-secondary">Cancelar</button>
            </div>
        </div>

        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('formatos')">Formatos Condicionales</button>
            <button class="tab-btn" onclick="switchTab('columnas')">Columnas</button>
        </div>

        <div class="config-content">
            <!-- Formatos Tab -->
            <div id="formatos-tab" class="tab-content active">
                <h2>Formatos Condicionales</h2>
                <p class="help-text">Crea formatos para aplicar colores a celdas o filas según condiciones.</p>
                
                <div id="formatos-list"></div>
                
                <button onclick="addFormato()" class="btn btn-primary">+ Agregar Formato</button>
                
                <div id="formatos-success" class="success-message"></div>
            </div>

            <!-- Columnas Tab -->
            <div id="columnas-tab" class="tab-content">
                <h2>Configuración de Columnas</h2>
                <p class="help-text">Configura la visibilidad y nombres de las columnas.</p>
                
                <div id="columnas-list"></div>
                
                <div id="columnas-success" class="success-message"></div>
            </div>
        </div>
    </div>

    <script>
        let tableau = window.tableau;
        let config = {
            conditionalFormats: [],
            columns: {}
        };

        function init() {
            tableau.extensions.initializeDialogAsync().then(() => {
                loadConfig();
                renderFormatos();
                renderColumnas();
            });
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName + '-tab').classList.add('active');
        }

        function loadConfig() {
            const settings = tableau.extensions.settings.getAll();
            
            if (settings.conditionalFormats) {
                config.conditionalFormats = JSON.parse(settings.conditionalFormats);
            }
            
            if (settings.columnsConfig) {
                config.columns = JSON.parse(settings.columnsConfig);
            }
        }

        function addFormato() {
            const newFormato = {
                id: Date.now(),
                name: 'Nuevo Formato',
                column: '',
                operator: '>',
                value: '0',
                backgroundColor: '#ffff00',
                textColor: '#000000',
                applyToRow: false,
                showIndicator: true,
                indicatorColor: '#ff0000'
            };
            
            config.conditionalFormats.push(newFormato);
            renderFormatos();
        }

        function removeFormato(id) {
            config.conditionalFormats = config.conditionalFormats.filter(f => f.id !== id);
            renderFormatos();
        }

        function renderFormatos() {
            const container = document.getElementById('formatos-list');
            
            if (config.conditionalFormats.length === 0) {
                container.innerHTML = '<p class="help-text">No hay formatos creados. Haz clic en "Agregar Formato" para crear uno.</p>';
                return;
            }
            
            container.innerHTML = config.conditionalFormats.map(formato => `
                <div class="formato-item" data-id="${formato.id}">
                    <div class="formato-header">
                        <input type="text" class="formato-name" value="${formato.name}" 
                            onchange="updateFormatoName(${formato.id}, this.value)">
                        <button class="btn-delete" onclick="removeFormato(${formato.id})">×</button>
                    </div>
                    
                    <div class="formato-config">
                        <div class="form-group">
                            <label>Columna</label>
                            <select onchange="updateFormato(${formato.id}, 'column', this.value)">
                                <option value="">Seleccionar...</option>
                                ${Object.keys(config.columns).map(col => 
                                    `<option value="${col}" ${formato.column === col ? 'selected' : ''}>${col}</option>`
                                ).join('')}
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>Operador</label>
                            <select onchange="updateFormato(${formato.id}, 'operator', this.value)">
                                <option value=">" ${formato.operator === '>' ? 'selected' : ''}>Mayor que (>)</option>
                                <option value="<" ${formato.operator === '<' ? 'selected' : ''}>Menor que (<)</option>
                                <option value="=" ${formato.operator === '=' ? 'selected' : ''}>Igual a (=)</option>
                                <option value=">=" ${formato.operator === '>=' ? 'selected' : ''}>Mayor o igual (>=)</option>
                                <option value="<=" ${formato.operator === '<=' ? 'selected' : ''}>Menor o igual (<=)</option>
                                <option value="equals" ${formato.operator === 'equals' ? 'selected' : ''}>Texto igual</option>
                                <option value="contains" ${formato.operator === 'contains' ? 'selected' : ''}>Contiene</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>Valor</label>
                            <input type="text" value="${formato.value}" 
                                onchange="updateFormato(${formato.id}, 'value', this.value)">
                        </div>
                        
                        <div class="form-group">
                            <label>Color de fondo</label>
                            <div class="color-group">
                                <input type="color" value="${formato.backgroundColor}" 
                                    onchange="updateFormato(${formato.id}, 'backgroundColor', this.value)">
                                <span>${formato.backgroundColor}</span>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Color de texto</label>
                            <div class="color-group">
                                <input type="color" value="${formato.textColor}" 
                                    onchange="updateFormato(${formato.id}, 'textColor', this.value)">
                                <span>${formato.textColor}</span>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Color de indicador</label>
                            <div class="color-group">
                                <input type="color" value="${formato.indicatorColor || '#ff0000'}" 
                                    onchange="updateFormato(${formato.id}, 'indicatorColor', this.value)">
                                <span>${formato.indicatorColor || '#ff0000'}</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="checkbox-group">
                        <input type="checkbox" ${formato.applyToRow ? 'checked' : ''} 
                            onchange="updateFormato(${formato.id}, 'applyToRow', this.checked)">
                        <label>Aplicar a toda la fila</label>
                    </div>
                    
                    <div class="checkbox-group">
                        <input type="checkbox" ${formato.showIndicator ? 'checked' : ''} 
                            onchange="updateFormato(${formato.id}, 'showIndicator', this.checked)">
                        <label>Mostrar indicador circular</label>
                    </div>
                </div>
            `).join('');
        }

        function updateFormatoName(id, name) {
            const formato = config.conditionalFormats.find(f => f.id === id);
            if (formato) formato.name = name;
        }

        function updateFormato(id, field, value) {
            const formato = config.conditionalFormats.find(f => f.id === id);
            if (formato) formato[field] = value;
            renderFormatos();
        }

        function renderColumnas() {
            const container = document.getElementById('columnas-list');
            
            if (Object.keys(config.columns).length === 0) {
                container.innerHTML = '<p class="help-text">No hay columnas configuradas.</p>';
                return;
            }
            
            container.innerHTML = Object.entries(config.columns).map(([colName, colConfig]) => `
                <div class="column-item">
                    <div class="column-header">
                        <span class="column-name">${colName}</span>
                    </div>
                    
                    <div class="form-group">
                        <label>Nombre para mostrar</label>
                        <input type="text" value="${colConfig.displayName || ''}" 
                            placeholder="Dejar vacío para usar nombre original"
                            onchange="updateColumn('${colName}', 'displayName', this.value)">
                    </div>
                    
                    <div class="checkbox-group">
                        <input type="checkbox" ${colConfig.visible !== false ? 'checked' : ''} 
                            onchange="updateColumn('${colName}', 'visible', this.checked)">
                        <label>Mostrar columna</label>
                    </div>
                </div>
            `).join('');
        }

        function updateColumn(colName, field, value) {
            if (config.columns[colName]) {
                config.columns[colName][field] = value;
            }
        }

        function saveAndClose() {
            tableau.extensions.settings.set('conditionalFormats', JSON.stringify(config.conditionalFormats));
            tableau.extensions.settings.set('columnsConfig', JSON.stringify(config.columns));
            
            tableau.extensions.settings.saveAsync().then(() => {
                tableau.extensions.ui.closeDialog('saved');
            });
        }

        function cancelAndClose() {
            tableau.extensions.ui.closeDialog('cancelled');
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
