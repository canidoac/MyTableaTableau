<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SuperTables - Configuración</title>
    <script src="https://cdn.jsdelivr.net/gh/tableau/extensions-api/lib/tableau.extensions.1.latest.min.js"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
    <link rel="stylesheet" href="config.css" />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        background: #f8f9fa;
        color: #333;
        overflow: hidden;
      }

      /* Prevent context menu (right-click) */
      body {
        -webkit-user-select: none;
        user-select: none;
      }
      
      input, textarea {
        -webkit-user-select: text;
        user-select: text;
      }

      html, body {
        margin: 0;
        padding: 0;
        width: 100%;
        height: 100%;
      }

      .config-container {
        display: flex;
        flex-direction: column;
        height: 100vh;
        overflow: hidden;
      }

      /* Fixed header styles */
      .config-header {
        background: white;
        border-bottom: 1px solid #e0e0e0;
        padding: 16px 24px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-shrink: 0;
      }

      .config-header h1 {
        font-size: 18px;
        color: #1a1a1a;
        font-weight: 600;
        margin: 0;
      }

      .header-actions {
        display: flex;
        gap: 10px;
      }

      /* Config content area with proper flex */
      .config-content {
        display: flex;
        flex-direction: column;
        flex: 1;
        overflow: hidden;
      }

      /* Horizontal tabs navigation */
      .tabs {
        display: flex;
        gap: 0;
        background: white;
        border-bottom: 2px solid #e0e0e0;
        padding: 0 24px;
        flex-shrink: 0;
      }

      .tab-btn {
        padding: 12px 20px;
        background: none;
        border: none;
        border-bottom: 3px solid transparent;
        cursor: pointer;
        font-size: 13px;
        font-weight: 500;
        color: #666;
        transition: all 0.2s;
        margin-bottom: -2px;
        position: relative;
      }

      .tab-btn:hover {
        color: #0066cc;
        background: #f8f9fa;
      }

      .tab-btn.active {
        color: #0066cc;
        border-bottom-color: #0066cc;
        background: transparent;
      }

      /* Tab panels container */
      .tab-panels {
        flex: 1;
        overflow-y: auto;
        background: #f8f9fa;
      }

      .tab-content {
        display: none;
        height: 100%;
      }

      .tab-content.active {
        display: flex;
        flex-direction: column;
      }

      /* New compact data layout with better spacing */
      .data-layout {
        display: flex;
        flex: 1;
        overflow: hidden;
        height: 100%;
      }

      .column-sidebar {
        width: 260px;
        background: white;
        border-right: 1px solid #e0e0e0;
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      .sidebar-header {
        padding: 16px;
        border-bottom: 1px solid #e0e0e0;
        background: #fafafa;
      }

      .search-reload-group {
        display: flex;
        gap: 8px;
        align-items: center;
      }

      .search-box {
        flex: 1;
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 13px;
      }

      .reload-btn {
        padding: 8px 12px;
        background: #2563eb;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 13px;
        white-space: nowrap;
        transition: background 0.2s;
      }

      .reload-btn:hover {
        background: #1d4ed8;
      }

      .column-list {
        flex: 1;
        padding: 12px;
        overflow-y: auto;
      }

      .column-section h3 {
        font-size: 11px;
        font-weight: 600;
        color: #666;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 8px;
        padding: 0 8px;
      }

      .column-item {
        padding: 8px 12px;
        margin-bottom: 2px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 13px;
        color: #333;
        transition: all 0.15s;
      }

      .column-item:hover {
        background-color: #f0f7ff;
      }

      .column-item.selected {
        background-color: #f2dc49;
        color: #1a1a1a;
        font-weight: 600;
      }

      .column-config-panel {
        flex: 1;
        background: white;
        padding: 24px;
        overflow-y: auto;
      }

      .empty-state {
        display: flex;
        align-items: center;
        justify-content: center;
        height: 100%;
        color: #999;
        font-size: 14px;
        font-style: italic;
      }

      /* Redesigned accordion-style sections */
      .config-section {
        border: 1px solid #e5e7eb;
        border-radius: 6px;
        margin-bottom: 12px;
        background: white;
        overflow: hidden;
      }

      .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 16px;
        background: #f9fafb;
        cursor: pointer;
        user-select: none;
        transition: background 0.2s;
      }

      .section-header:hover {
        background: #f3f4f6;
      }

      .section-header h4 {
        font-size: 14px;
        font-weight: 600;
        color: #374151;
        margin: 0;
      }

      .section-toggle {
        font-size: 18px;
        color: #6b7280;
        transition: transform 0.2s;
      }

      .section-header.collapsed .section-toggle {
        transform: rotate(-90deg);
      }

      .section-content {
        padding: 16px;
        border-top: 1px solid #e5e7eb;
        display: none;
      }

      .section-content.expanded {
        display: block;
      }

      /* Compact horizontal form layout */
      .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
        margin-bottom: 12px;
      }

      .form-row.single {
        grid-template-columns: 1fr;
      }

      .form-group {
        margin-bottom: 0;
      }

      .form-group label {
        display: block;
        margin-bottom: 6px;
        font-weight: 500;
        color: #374151;
        font-size: 12px;
      }

      .form-group input[type="text"],
      .form-group input[type="number"],
      .form-group select {
        width: 100%;
        padding: 8px 10px;
        border: 1px solid #d1d5db;
        border-radius: 4px;
        font-size: 13px;
        transition: border-color 0.2s;
      }

      .form-group input:focus,
      .form-group select:focus {
        outline: none;
        border-color: #2563eb;
      }

      .form-group input[type="color"] {
        width: 50px;
        height: 32px;
        border: 1px solid #d1d5db;
        border-radius: 4px;
        cursor: pointer;
        padding: 2px;
      }

      .checkbox-group {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 6px 0;
      }

      .checkbox-group input[type="checkbox"] {
        width: 16px;
        height: 16px;
        cursor: pointer;
      }

      .checkbox-group label {
        margin: 0;
        cursor: pointer;
        font-size: 13px;
        font-weight: 400;
        color: #374151;
      }

      /* Compact conditional formatting rules */
      .conditional-rule {
        background: #ffffff;
        border: 1px solid #e5e7eb;
        border-radius: 6px;
        padding: 12px;
        margin-bottom: 12px;
      }

      .rule-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
        padding-bottom: 8px;
        border-bottom: 1px solid #f3f4f6;
      }

      .rule-title {
        font-weight: 600;
        font-size: 13px;
        color: #374151;
      }

      .delete-rule-btn {
        padding: 4px 12px;
        background: #ef4444;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 11px;
        font-weight: 500;
      }

      .delete-rule-btn:hover {
        background: #dc2626;
      }

      /* Horizontal layout for rule conditions */
      .rule-condition-grid {
        display: grid;
        grid-template-columns: 140px 1fr 1fr;
        gap: 10px;
        margin-bottom: 12px;
      }

      .rule-condition-grid.with-between {
        grid-template-columns: 140px 1fr 1fr;
      }

      .rule-input-group {
        display: flex;
        flex-direction: column;
        gap: 4px;
      }

      .rule-input-group label {
        font-size: 11px;
        color: #6b7280;
        font-weight: 500;
      }

      .rule-input-group select,
      .rule-input-group input {
        padding: 6px 8px;
        border: 1px solid #d1d5db;
        border-radius: 4px;
        font-size: 12px;
      }

      .rule-condition-row {
        display: grid;
        grid-template-columns: 1fr 1.2fr;
        gap: 10px;
        margin-bottom: 12px;
      }

      .rule-formatting-row {
        display: grid;
        grid-template-columns: auto 1fr repeat(3, auto);
        gap: 8px;
        align-items: center;
        padding: 8px;
        background: #f9fafb;
        border-radius: 4px;
      }

      .rule-formatting-row label {
        font-size: 11px;
        font-weight: 500;
        color: #374151;
      }

      .rule-formatting-row select {
        padding: 5px 8px;
        border: 1px solid #d1d5db;
        border-radius: 4px;
        font-size: 11px;
        min-width: 100px;
      }

      .rule-formatting-row input[type="color"] {
        width: 36px;
        height: 28px;
        border: 1px solid #d1d5db;
        border-radius: 4px;
        cursor: pointer;
      }

      .rule-formatting-row input[type="checkbox"] {
        width: 16px;
        height: 16px;
        cursor: pointer;
      }

      /* Compact grid for formatting options */
      .rule-formatting-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 8px;
        padding-top: 12px;
        border-top: 1px solid #e5e7eb;
      }

      .format-option {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 12px;
      }

      .format-option input[type="checkbox"] {
        width: 14px;
        height: 14px;
      }

      .format-option input[type="color"] {
        width: 32px;
        height: 24px;
        border: 1px solid #d1d5db;
        border-radius: 3px;
        cursor: pointer;
        padding: 1px;
      }

      .format-option select {
        padding: 4px 6px;
        border: 1px solid #d1d5db;
        border-radius: 3px;
        font-size: 11px;
      }

      .format-option label {
        font-size: 11px;
        color: #6b7280;
        cursor: pointer;
        margin: 0;
      }

      /* Buttons */
      .btn {
        padding: 8px 16px;
        border: none;
        border-radius: 5px;
        font-size: 13px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
      }

      .btn-primary {
        background: #28a745;
        color: white;
      }

      .btn-primary:hover {
        background: #218838;
      }

      .btn-secondary {
        background: #dc3545;
        color: white;
      }

      .btn-secondary:hover {
        background: #c82333;
      }

      .btn-success {
        background: #2563eb;
        color: white;
        width: 100%;
        padding: 10px;
        margin-top: 12px;
      }

      .btn-success:hover {
        background: #1d4ed8;
      }

      .add-rule-btn {
        width: 100%;
        padding: 10px;
        background: #10b981;
        color: white;
        border: none;
        border-radius: 5px;
        font-size: 13px;
        font-weight: 500;
        cursor: pointer;
        transition: background 0.2s;
        margin-top: 8px;
      }

      .add-rule-btn:hover {
        background: #059669;
      }

      /* General content section for non-data tabs */
      .content-section {
        background: white;
        padding: 24px;
        margin: 24px;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      }

      .content-section h2 {
        font-size: 18px;
        margin-bottom: 20px;
        color: #1a1a1a;
        font-weight: 600;
      }

      .content-section h3 {
        font-size: 15px;
        margin: 20px 0 12px;
        color: #374151;
        font-weight: 600;
      }

      .help-text {
        margin-top: 4px;
        font-size: 12px;
        color: #6b7280;
      }

      .section-divider {
        height: 1px;
        background: #e5e7eb;
        margin: 20px 0;
      }

      .color-preview {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .color-preview span {
        font-size: 12px;
        color: #6b7280;
        font-family: monospace;
      }

      /* Info tab specific */
      .info-grid {
        display: grid;
        gap: 12px;
        margin-top: 16px;
      }

      .info-item {
        background: #f9fafb;
        padding: 12px 16px;
        border-radius: 6px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 13px;
      }

      .info-item strong {
        color: #374151;
      }

      .status-badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 500;
      }

      .status-online {
        background: #d1fae5;
        color: #065f46;
      }

      .feature-list {
        list-style: none;
        margin-top: 16px;
        padding: 0;
      }

      .feature-list li {
        padding: 6px 0;
        padding-left: 24px;
        position: relative;
        font-size: 13px;
        color: #374151;
      }

      .feature-list li:before {
        content: '✓';
        position: absolute;
        left: 0;
        color: #10b981;
        font-weight: bold;
        font-size: 14px;
      }

      /* Config saved message */
      .config-saved-message {
        display: none;
        margin-top: 12px;
        padding: 10px 14px;
        background: #10b981;
        color: white;
        border-radius: 5px;
        font-size: 13px;
        font-weight: 500;
      }

      .config-saved-message.show {
        display: block;
        animation: slideIn 0.3s ease-out;
      }

      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateY(-10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* Scrollbar styling */
      ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
      }

      ::-webkit-scrollbar-track {
        background: #f1f1f1;
      }

      ::-webkit-scrollbar-thumb {
        background: #c1c1c1;
        border-radius: 4px;
      }

      ::-webkit-scrollbar-thumb:hover {
        background: #a1a1a1;
      }

      /* CHANGE: Added styles for priorities tab */
      .priority-item {
        background: white;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        padding: 12px;
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        gap: 12px;
        cursor: move;
        transition: all 0.2s;
      }

      .priority-item:hover {
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        border-color: #2563eb;
      }

      .priority-item.dragging {
        opacity: 0.5;
      }

      .priority-number {
        background: #2563eb;
        color: white;
        width: 28px;
        height: 28px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 13px;
        flex-shrink: 0;
      }

      .priority-drag-handle {
        cursor: grab;
        color: #9ca3af;
        font-size: 18px;
        flex-shrink: 0;
      }

      .priority-drag-handle:active {
        cursor: grabbing;
      }

      .priority-info {
        flex: 1;
        min-width: 0;
      }

      .priority-column-name {
        font-weight: 600;
        font-size: 13px;
        color: #1f2937;
        margin-bottom: 4px;
      }

      .priority-rule-details {
        font-size: 11px;
        color: #6b7280;
        display: flex;
        align-items: center;
        gap: 8px;
        flex-wrap: wrap;
      }

      .priority-badge {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 2px 8px;
        border-radius: 3px;
        font-size: 11px;
        font-weight: 500;
      }

      .badge-cell {
        background: #dbeafe;
        color: #1e40af;
      }

      .badge-row {
        background: #fee2e2;
        color: #991b1b;
      }

      .priority-actions {
        display: flex;
        flex-direction: column;
        gap: 4px;
        flex-shrink: 0;
      }

      .priority-btn {
        background: #f3f4f6;
        border: 1px solid #d1d5db;
        border-radius: 4px;
        width: 28px;
        height: 28px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 14px;
        color: #4b5563;
        transition: all 0.15s;
      }

      .priority-btn:hover {
        background: #e5e7eb;
        border-color: #9ca3af;
      }

      .priority-btn:disabled {
        opacity: 0.4;
        cursor: not-allowed;
      }
    </style>
  </head>
  <body>
    <script>
      document.addEventListener('contextmenu', event => event.preventDefault());
    </script>

    <div class="config-container">
      <header class="config-header">
        <h1>SuperTables - Configuración <span style="font-size: 13px; color: #999; font-weight: 400;">v9.0.0</span></h1>
        <div class="header-actions">
          <button id="cancel-btn" class="btn btn-secondary" onclick="closeDialog()">Cancelar</button>
          <button id="save-btn" class="btn btn-primary" onclick="saveAndClose()">Guardar y Cerrar</button>
        </div>
      </header>

      <!-- CHANGE: Changed nav structure for tabs -->
      <div class="tabs-container">
        <nav class="tabs">
          <button class="tab-btn active" data-tab="general">General</button>
          <button class="tab-btn" data-tab="data">Data</button>
          <!-- Renamed Priorities tab to Formatos for creating reusable formats -->
          <button class="tab-btn" data-tab="formatos">Formatos</button>
          <button class="tab-btn" data-tab="export">Export</button>
          <button class="tab-btn" data-tab="info">Información</button>
        </nav>
      </div>

      <div class="tab-panels">
        <!-- General Tab -->
        <div id="general-tab" class="tab-content active">
          <div class="content-section">
            <h2>Configuración General</h2>

            <div class="form-group">
              <label>Hoja de trabajo</label>
              <select id="worksheet-select">
                <option value="">La hoja se selecciona desde la extensión</option>
              </select>
              <p class="help-text">Selecciona la hoja de trabajo desde la cual se cargarán los datos</p>
            </div>

            <div class="section-divider"></div>

            <div class="form-group">
              <label>Título de la tabla</label>
              <input type="text" id="table-title" placeholder="Ej: Mi Tabla de Datos" />
              <p class="help-text">Este título aparecerá en la parte superior de la tabla</p>
            </div>

            <div class="section-divider"></div>

            <h3>Opciones de visualización</h3>
            <div class="checkbox-group">
              <input type="checkbox" id="show-search" checked />
              <label for="show-search">Mostrar buscador</label>
            </div>
            <div class="checkbox-group">
              <input type="checkbox" id="show-row-count" checked />
              <label for="show-row-count">Mostrar contador de filas</label>
            </div>
          </div>
        </div>

        <!-- Data Tab -->
        <div id="data-tab" class="tab-content">
          <div class="data-layout">
            <aside class="column-sidebar">
              <div class="sidebar-header">
                <div class="search-reload-group">
                  <input type="text" id="column-search" class="search-box" placeholder="Buscar..." />
                  <button onclick="reloadColumns()" class="reload-btn" title="Recargar columnas">↻</button>
                </div>
              </div>
              <div class="column-list">
                <div class="column-section">
                  <h3>DIMENSIONES</h3>
                  <div id="dimensions-list"></div>
                </div>
                <div class="column-section" style="margin-top: 20px;">
                  <h3>MEDIDAS</h3>
                  <div id="measures-list"></div>
                </div>
              </div>
            </aside>

            <div class="column-config-panel">
              <div id="column-config-placeholder" class="empty-state">
                Selecciona una columna de la lista para configurar sus opciones
              </div>
              
              <div id="column-config-content" style="display: none;">
                <h2 id="config-column-title" style="margin-bottom: 20px; font-size: 18px;">Configurar Columna</h2>
                
                <!-- Organized config sections with accordions -->
                <div class="config-section">
                  <div class="section-header expanded" onclick="toggleSection(this)">
                    <h4>Opciones Básicas</h4>
                    <span class="section-toggle">▼</span>
                  </div>
                  <div class="section-content expanded">
                    <div class="form-group">
                      <label>Nombre para mostrar</label>
                      <input type="text" id="column-display-name" placeholder="Nombre personalizado" />
                      <p class="help-text">Deja vacío para usar el nombre original</p>
                    </div>

                    <div class="checkbox-group">
                      <input type="checkbox" id="column-visible" checked />
                      <label for="column-visible">Mostrar esta columna en la tabla</label>
                    </div>

                    <div class="checkbox-group">
                      <input type="checkbox" id="column-export" checked />
                      <label for="column-export">Incluir en exportaciones</label>
                    </div>
                  </div>
                </div>

                <!-- New conditional rules section that selects from created formats -->
                <div class="config-section">
                  <div class="section-header expanded" onclick="toggleSection(this)">
                    <h4>Reglas Condicionales</h4>
                    <span class="section-toggle">▼</span>
                  </div>
                  <div class="section-content expanded">
                    <p class="help-text" style="margin-bottom: 16px;">Define cuando aplicar un formato creado en la pestaña Formatos</p>
                    <div id="column-rules-container">
                      <!-- Rules will be added here dynamically -->
                    </div>
                    
                    <button class="add-rule-btn" onclick="addColumnRule()">
                      + Agregar Regla Condicional
                    </button>
                  </div>
                </div>

                <button type="button" onclick="saveColumnConfig()" class="btn btn-success">
                  Guardar Configuración
                </button>
                
                <div id="config-saved-message" class="config-saved-message">
                  ✓ Configuración guardada correctamente
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Export Tab -->
        <div id="export-tab" class="tab-content">
          <div class="content-section">
            <h2>Configuración de Exportación</h2>

            <div class="form-group">
              <label>Nombre base del archivo</label>
              <input type="text" id="export-filename" placeholder="mi-tabla" />
              <p class="help-text">Se agregará la fecha automáticamente al exportar</p>
            </div>

            <div class="section-divider"></div>

            <div class="form-group">
              <label>Texto del botón</label>
              <input type="text" id="export-button-text" placeholder="Exportar" />
              <p class="help-text">Personaliza el texto que aparece en el botón de exportación</p>
            </div>

            <div class="section-divider"></div>

            <h3>Colores del botón</h3>
            <div class="form-group">
              <label>Color de fondo</label>
              <div class="color-preview">
                <input type="color" id="export-button-color" value="#2563eb" />
                <span id="export-color-value-bg">#2563eb</span>
              </div>
            </div>

            <div class="form-group">
              <label>Color del texto</label>
              <div class="color-preview">
                <input type="color" id="export-button-text-color" value="#ffffff" />
                <span id="export-color-value-text">#ffffff</span>
              </div>
            </div>

            <div class="section-divider"></div>

            <h3>Formatos disponibles</h3>
            <div class="checkbox-group">
              <input type="checkbox" id="export-enable-excel" checked />
              <label for="export-enable-excel">Habilitar exportación a Excel (.xlsx)</label>
            </div>
            <div class="checkbox-group">
              <input type="checkbox" id="export-enable-csv" checked />
              <label for="export-enable-csv">Habilitar exportación a CSV</label>
            </div>
            <div class="checkbox-group">
              <input type="checkbox" id="export-enable-pdf" checked />
              <label for="export-enable-pdf">Habilitar exportación a PDF</label>
            </div>
          </div>
        </div>

        <!-- Design Tab -->
        <div id="design-tab" class="tab-content">
          <div class="content-section">
            <h2>Diseño de la Tabla</h2>
            <p class="help-text" style="margin-bottom: 20px;">Personaliza la apariencia visual de tu tabla</p>

            <div class="section-header expanded" onclick="toggleSection(this)">
              <h3>Encabezados</h3>
              <span class="section-toggle">▼</span>
            </div>
            <div class="section-content expanded" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
              <div class="form-group">
                <label>Fuente</label>
                <select id="design-header-font" style="width: 100%; padding: 6px; border: 1px solid #d1d5db; border-radius: 4px;">
                  <option value="Arial, sans-serif">Arial</option>
                  <option value="'Helvetica Neue', Helvetica, sans-serif">Helvetica</option>
                  <option value="'Segoe UI', Tahoma, sans-serif">Segoe UI</option>
                  <option value="'Roboto', sans-serif">Roboto</option>
                  <option value="'Open Sans', sans-serif">Open Sans</option>
                  <option value="Georgia, serif">Georgia</option>
                  <option value="'Times New Roman', serif">Times New Roman</option>
                  <option value="'Courier New', monospace">Courier New</option>
                </select>
              </div>
              
              <div class="form-group">
                <label>Tamaño de fuente</label>
                <select id="design-header-font-size" style="width: 100%; padding: 6px; border: 1px solid #d1d5db; border-radius: 4px;">
                  <option value="11px">11px</option>
                  <option value="12px">12px</option>
                  <option value="13px">13px</option>
                  <option value="14px" selected>14px</option>
                  <option value="15px">15px</option>
                  <option value="16px">16px</option>
                  <option value="18px">18px</option>
                </select>
              </div>
              
              <div class="form-group">
                <label>Color de fondo</label>
                <div style="display: flex; align-items: center; gap: 8px;">
                  <input type="color" id="design-header-bg" value="#f3f4f6" style="width: 50px; height: 32px; border: 1px solid #d1d5db; border-radius: 4px;">
                  <span id="design-header-bg-value" style="font-size: 12px; color: #6b7280;">#f3f4f6</span>
                </div>
              </div>
              
              <div class="form-group">
                <label>Color de texto</label>
                <div style="display: flex; align-items: center; gap: 8px;">
                  <input type="color" id="design-header-text" value="#111827" style="width: 50px; height: 32px; border: 1px solid #d1d5db; border-radius: 4px;">
                  <span id="design-header-text-value" style="font-size: 12px; color: #6b7280;">#111827</span>
                </div>
              </div>
            </div>

            <div class="section-header expanded" onclick="toggleSection(this)">
              <h3>Cuerpo de la tabla</h3>
              <span class="section-toggle">▼</span>
            </div>
            <div class="section-content expanded" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
              <div class="form-group">
                <label>Fuente</label>
                <select id="design-body-font" style="width: 100%; padding: 6px; border: 1px solid #d1d5db; border-radius: 4px;">
                  <option value="Arial, sans-serif">Arial</option>
                  <option value="'Helvetica Neue', Helvetica, sans-serif">Helvetica</option>
                  <option value="'Segoe UI', Tahoma, sans-serif">Segoe UI</option>
                  <option value="'Roboto', sans-serif">Roboto</option>
                  <option value="'Open Sans', sans-serif">Open Sans</option>
                  <option value="Georgia, serif">Georgia</option>
                  <option value="'Times New Roman', serif">Times New Roman</option>
                  <option value="'Courier New', monospace">Courier New</option>
                </select>
              </div>
              
              <div class="form-group">
                <label>Tamaño de fuente</label>
                <select id="design-body-font-size" style="width: 100%; padding: 6px; border: 1px solid #d1d5db; border-radius: 4px;">
                  <option value="11px">11px</option>
                  <option value="12px">12px</option>
                  <option value="13px" selected>13px</option>
                  <option value="14px">14px</option>
                  <option value="15px">15px</option>
                  <option value="16px">16px</option>
                </select>
              </div>
              
              <div class="form-group">
                <label>Color de texto</label>
                <div style="display: flex; align-items: center; gap: 8px;">
                  <input type="color" id="design-body-text" value="#374151" style="width: 50px; height: 32px; border: 1px solid #d1d5db; border-radius: 4px;">
                  <span id="design-body-text-value" style="font-size: 12px; color: #6b7280;">#374151</span>
                </div>
              </div>
              
              <div class="form-group">
                <label>Fondo fila par</label>
                <div style="display: flex; align-items: center; gap: 8px;">
                  <input type="color" id="design-row-even" value="#ffffff" style="width: 50px; height: 32px; border: 1px solid #d1d5db; border-radius: 4px;">
                  <span id="design-row-even-value" style="font-size: 12px; color: #6b7280;">#ffffff</span>
                </div>
              </div>
              
              <div class="form-group">
                <label>Fondo fila impar</label>
                <div style="display: flex; align-items: center; gap: 8px;">
                  <input type="color" id="design-row-odd" value="#f9fafb" style="width: 50px; height: 32px; border: 1px solid #d1d5db; border-radius: 4px;">
                  <span id="design-row-odd-value" style="font-size: 12px; color: #6b7280;">#f9fafb</span>
                </div>
              </div>
            </div>

            <div class="section-header expanded" onclick="toggleSection(this)">
              <h3>Bordes</h3>
              <span class="section-toggle">▼</span>
            </div>
            <div class="section-content expanded" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
              <div class="form-group">
                <label>Color de borde</label>
                <div style="display: flex; align-items: center; gap: 8px;">
                  <input type="color" id="design-border-color" value="#e5e7eb" style="width: 50px; height: 32px; border: 1px solid #d1d5db; border-radius: 4px;">
                  <span id="design-border-color-value" style="font-size: 12px; color: #6b7280;">#e5e7eb</span>
                </div>
              </div>
              
              <div class="form-group">
                <label>Grosor de borde</label>
                <select id="design-border-width" style="width: 100%; padding: 6px; border: 1px solid #d1d5db; border-radius: 4px;">
                  <option value="0px">Sin borde</option>
                  <option value="1px" selected>1px</option>
                  <option value="2px">2px</option>
                  <option value="3px">3px</option>
                </select>
              </div>
            </div>

            <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #e5e7eb;">
              <button type="button" onclick="resetDesign()" style="padding: 8px 16px; background: #6b7280; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px;">
                Restaurar valores por defecto
              </button>
              <button type="button" onclick="saveDesignSettings()" style="padding: 8px 16px; background: #2563eb; color: white; border: none; border-radius: 4px; cursor: pointer;">
                Aplicar cambios
              </button>
            </div>
          </div>
        </div>

        <!-- Replaced Priorities Tab with Formatos Tab for creating reusable formats -->
        <div id="formatos-tab" class="tab-content">
          <div class="content-section">
            <h2>Formatos Reutilizables</h2>
            <p class="help-text" style="margin-bottom: 20px;">
              Crea formatos de estilo que podrás aplicar en las reglas condicionales de cualquier columna.
            </p>

            <div id="formatos-list-container" style="margin-bottom: 20px;">
              <!-- Format items will be generated here -->
            </div>

            <button onclick="addNewFormat()" class="btn btn-success" style="width: auto; display: inline-block; margin-right: 10px;">
              + Crear Nuevo Formato
            </button>
            
            <button onclick="saveFormats()" class="btn btn-primary" style="width: auto; display: inline-block;">
              Guardar Formatos
            </button>

            <div id="formatos-saved-message" class="config-saved-message">
              ✓ Formatos guardados correctamente
            </div>
          </div>
        </div>

        <!-- Information Tab -->
        <div id="info-tab" class="tab-content">
          <div class="content-section">
            <h2>Información de la Extensión</h2>

            <div class="info-grid">
              <div class="info-item">
                <strong>Nombre:</strong>
                <span>SuperTables Pro - MeliTable</span>
              </div>
              <div class="info-item">
                <strong>Versión:</strong>
                <span>v9.0.0</span>
              </div>
              <div class="info-item">
                <strong>Estado:</strong>
                <span class="status-badge status-online">● Online</span>
              </div>
              <div class="info-item">
                <strong>Descripción:</strong>
                <span>Extensión de tabla mejorada para Tableau con exportación, búsqueda, configuración avanzada de columnas y formato condicional</span>
              </div>
            </div>

            <div class="section-divider"></div>

            <h3>Características:</h3>
            <ul class="feature-list">
              <li>Exportación a Excel, CSV y PDF con nombres personalizables</li>
              <li>Búsqueda y filtrado en tiempo real</li>
              <li>Configuración personalizada de columnas</li>
              <li>Nombres de visualización personalizables</li>
              <li>Formato condicional con iconos y colores</li>
              <li>Control de inclusión de columnas en exportaciones</li>
              <li>Ordenamiento por columnas</li>
              <li>Paginación configurable</li>
              <li>Google Material Icons integrados</li>
            </ul>
          </div>
        </div>
      </div>
    </div>

    <script>
      console.log("[v0] Config.html script starting...")
      
      let allColumns = []
      let currentSelectedColumn = null
      let columnsConfig = {}
      let conditionalRuleCounter = 0;
      
      let savedFormats = {}; // Object to store all created formats
      let formatCounter = 0;

      if (typeof tableau === 'undefined') {
        console.error("[v0] Tableau Extensions API not loaded!")
        alert("Error: La API de Tableau Extensions no se ha cargado correctamente.")
        // Optionally, you might want to disable further execution or provide a fallback
      }

      async function loadColumnsFromWorksheet(worksheetName) {
        console.log("[v0] Loading columns from worksheet:", worksheetName)
        
        try {
          if (!worksheetName) {
            console.warn("[v0] No worksheet name provided")
            allColumns = []
            renderColumnList()
            return
          }
          
          // Get the worksheet object
          const dashboard = tableau.extensions.dashboardContent.dashboard
          const worksheet = dashboard.worksheets.find(ws => ws.name === worksheetName)
          
          if (!worksheet) {
            console.error("[v0] Worksheet not found:", worksheetName)
            allColumns = []
            renderColumnList()
            return
          }
          
          console.log("[v0] Found worksheet, fetching data...")
          const dataTable = await worksheet.getSummaryDataAsync()
          console.log("[v0] Data received, columns:", dataTable.columns.length)
          
          // Store columns in global variable
          allColumns = dataTable.columns.map(col => ({
            fieldName: col.fieldName,
            dataType: col.dataType,
            index: col.index
          }))
          
          console.log("[v0] Columns loaded:", allColumns.length)
          
          // Also save to settings for persistence
          tableau.extensions.settings.set("dialogColumns", JSON.stringify(allColumns))
          
          // Re-render the column list
          renderColumnList()
          
        } catch (error) {
          console.error("[v0] Error loading columns:", error)
          alert("Error al cargar las columnas: " + error.message)
          allColumns = []
          renderColumnList()
        }
      }

      document.addEventListener("DOMContentLoaded", function() {
        console.log("[v0] DOM loaded, initializing Tableau Extensions...")
        
        initializeDialog(); // Changed from tableau.extensions.initializeDialogAsync()
      })

      function loadSettings() {
        console.log("[v0] Loading settings into form...")
        const settings = tableau.extensions.settings.getAll()
        
        // General tab
        document.getElementById("table-title").value = settings.tableTitle || ""
        document.getElementById("show-search").checked = settings.showSearch !== "false" && settings.showSearch !== false
        document.getElementById("show-row-count").checked = settings.showRowCount !== "false" && settings.showRowCount !== false
        
        // Export tab
        document.getElementById("export-filename").value = settings.exportFilename || "datos"
        document.getElementById("export-button-text").value = settings.exportButtonText || "Exportar"
        document.getElementById("export-button-color").value = settings.exportButtonColor || "#2563eb"
        document.getElementById("export-button-text-color").value = settings.exportButtonTextColor || "#ffffff"
        document.getElementById("export-enable-excel").checked = settings.exportEnableExcel !== "false" && settings.exportEnableExcel !== false
        document.getElementById("export-enable-csv").checked = settings.exportEnableCSV !== "false" && settings.exportEnableCSV !== false
        document.getElementById("export-enable-pdf").checked = settings.exportEnablePDF !== "false" && settings.exportEnablePDF !== false
        
        // Update color value spans
        const bgSpan = document.getElementById("export-color-value-bg");
        if (bgSpan) bgSpan.textContent = settings.exportButtonColor || "#2563eb";
        const textSpan = document.getElementById("export-color-value-text");
        if (textSpan) textSpan.textContent = settings.exportButtonTextColor || "#ffffff";

        console.log("[v0] Settings loaded successfully")
      }

      function setupEventListeners() {
        console.log("[v0] Setting up event listeners...")
        
        // Column search
        const columnSearch = document.getElementById("column-search")
        if (columnSearch) {
          columnSearch.addEventListener("input", filterColumns)
        }
        
        // Color picker updates
        document.getElementById("export-button-color").addEventListener("input", function() {
          document.getElementById("export-color-value-bg").textContent = this.value;
        });
        document.getElementById("export-button-text-color").addEventListener("input", function() {
          document.getElementById("export-color-value-text").textContent = this.value;
        });
        
        const worksheetSelect = document.getElementById("worksheet-select");
        if (worksheetSelect) {
          worksheetSelect.addEventListener("change", async function() {
            console.log("[v0] Worksheet selected:", this.value);
            tableau.extensions.settings.set("worksheet", this.value);
            
            // Load columns from the selected worksheet
            await loadColumnsFromWorksheet(this.value);
          });
        }

        // Tab button click listeners
        document.querySelectorAll('.tab-btn').forEach(button => {
          button.addEventListener('click', () => {
            const tabName = button.getAttribute('data-tab');
            switchTab(tabName);
          });
        });

        console.log("[v0] All event listeners set up")
      }

      function filterColumns() {
        const searchTerm = document.getElementById("column-search").value.toLowerCase()
        document.querySelectorAll(".column-item").forEach((item) => {
          const text = item.textContent.toLowerCase()
          item.style.display = text.includes(searchTerm) ? "block" : "none"
        })
      }

      function switchTab(tabName) {
        document.querySelectorAll('.tab-content').forEach(tab => {
          tab.classList.remove('active');
        });
        
        document.querySelectorAll('.tab-btn').forEach(btn => {
          btn.classList.remove('active');
        });
        
        document.getElementById(tabName + '-tab').classList.add('active');
        
        const clickedButton = document.querySelector(`.tab-btn[data-tab="${tabName}"]`);
        if (clickedButton) {
          clickedButton.classList.add('active');
        }

        // Load formats list when switching to formatos tab
        if (tabName === 'formatos') {
          loadFormatosList();
        }
      }

      function renderColumnList() {
        console.log("[v0] Rendering column list, allColumns:", allColumns)
        const dimensionsList = document.getElementById("dimensions-list")
        const measuresList = document.getElementById("measures-list")

        if (!dimensionsList || !measuresList) {
          console.error("[v0] Column list containers not found")
          return
        }

        dimensionsList.innerHTML = ""
        measuresList.innerHTML = ""

        if (!allColumns || !Array.isArray(allColumns) || allColumns.length === 0) {
          console.warn("[v0] No columns to display or allColumns is not an array")
          dimensionsList.innerHTML = '<div class="empty-state">No hay dimensiones disponibles</div>'
          measuresList.innerHTML = '<div class="empty-state">No hay medidas disponibles</div>'
          return
        }

        console.log("[v0] Rendering", allColumns.length, "columns")
        
        let dimensionCount = 0
        let measureCount = 0
        
        allColumns.forEach((col) => {
          const colName = col.fieldName || col.name || col
          
          const item = document.createElement("div")
          item.className = "column-item"
          item.textContent = colName
          item.setAttribute("data-column", colName)
          
          item.addEventListener("click", function () {
            console.log("[v0] Column clicked:", colName)
            selectColumn(colName, col)
          })

          // Determine if dimension or measure
          const isDimension = col.isDimension || col.aggregation === "NONE" || col.dataType === "string"
          
          if (isDimension) {
            dimensionsList.appendChild(item)
            dimensionCount++
          } else {
            measuresList.appendChild(item)
            measureCount++
          }
        })

        console.log("[v0] Rendered", dimensionCount, "dimensions and", measureCount, "measures")
        
        if (dimensionCount === 0) {
          dimensionsList.innerHTML = '<div class="empty-state">No hay dimensiones</div>'
        }
        if (measureCount === 0) {
          measuresList.innerHTML = '<div class="empty-state">No hay medidas</div>'
        }
      }

      function selectColumn(colName, columnInfo) {
        console.log("[v0] Selecting column:", colName, columnInfo)
        currentSelectedColumn = colName

        // Update visual selection
        document.querySelectorAll(".column-item").forEach((item) => item.classList.remove("selected"))
        const selectedItem = document.querySelector(`[data-column="${colName}"]`)
        if (selectedItem) {
          selectedItem.classList.add("selected")
        }

        // Show config panel
        document.getElementById("column-config-placeholder").style.display = "none"
        document.getElementById("column-config-content").style.display = "block"

        const columnData = columnsConfig[colName] || {
          visible: true,
          includeInExport: true,
        }

        document.getElementById("config-column-title").textContent = `Configurar: ${colName}`
        document.getElementById("column-display-name").value = columnData.displayName || ""
        document.getElementById("column-visible").checked = columnData.visible !== false
        document.getElementById("column-export").checked = columnData.includeInExport !== false

        showColumnRules(colName);
      }

      function showColumnRules(columnName) {
        console.log("[v0] Showing rules for column:", columnName)
        currentSelectedColumn = columnName

        const columnData = columnsConfig[columnName] || {}
        const column = allColumns.find((c) => c.fieldName === columnName)
        const isDimension = column?.dataType === "string" || false;

        const container = document.getElementById("column-rules-container");
        container.innerHTML = "";
        
        if (columnData.conditionalRules && Array.isArray(columnData.conditionalRules)) {
          columnData.conditionalRules.forEach((rule, index) => {
            addColumnRule(rule, isDimension);
          });
        }
      }

      function addColumnRule(ruleData = null, isDimension = null) {
        if (isDimension === null) {
          const column = allColumns.find(c => c.fieldName === currentSelectedColumn);
          isDimension = column?.dataType === "string" || false;
        }

        const ruleId = `column-rule-${Date.now()}`;
        const container = document.getElementById("column-rules-container");
        
        const operatorOptions = isDimension ? `
          <option value="equals">Es igual a</option>
          <option value="notEquals">No es igual a</option>
          <option value="contains">Contiene</option>
          <option value="notContains">No contiene</option>
          <option value="startsWith">Empieza con</option>
          <option value="endsWith">Termina con</option>
          <option value="isEmpty">Está vacío</option>
          <option value="isNotEmpty">No está vacío</option>
        ` : `
          <option value=">=">Mayor o igual (>=)</option>
          <option value="<=">Menor o igual (<=)</option>
          <option value="=">Igual (=)</option>
          <option value=">">Mayor (>)</option>
          <option value="<">Menor (<)</option>
          <option value="!=">Diferente (!=)</option>
          <option value="between">Entre</option>
        `;

        // Get list of available formats for dropdown
        const formatOptions = Object.keys(savedFormats).map(formatId => {
          const format = savedFormats[formatId];
          return `<option value="${formatId}">${format.name}</option>`;
        }).join('');

        const ruleDiv = document.createElement("div");
        ruleDiv.className = "conditional-rule";
        ruleDiv.id = ruleId;
        
        ruleDiv.innerHTML = `
          <div class="rule-header">
            <span class="rule-title">Regla ${container.children.length + 1}</span>
            <button class="delete-rule-btn" onclick="deleteColumnRule('${ruleId}')">Eliminar</button>
          </div>
          
          <div class="rule-condition-row">
            <div class="rule-input-group">
              <label>Operador</label>
              <select class="rule-operator">${operatorOptions}</select>
            </div>
            <div class="rule-input-group">
              <label>Valor</label>
              <input type="${isDimension ? 'text' : 'number'}" class="rule-value" placeholder="Valor">
              <input type="number" class="rule-value2" placeholder="Valor 2" style="display:none; margin-top: 4px;">
            </div>
          </div>
          
          <div class="form-group" style="margin-top: 12px;">
            <label>Formato a aplicar</label>
            <select class="rule-format-select" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px;">
              <option value="">Selecciona un formato...</option>
              ${formatOptions}
            </select>
            <p class="help-text">Crea formatos en la pestaña "Formatos"</p>
          </div>
        `;

        container.appendChild(ruleDiv);

        const operatorSelect = ruleDiv.querySelector(".rule-operator");
        const value2Input = ruleDiv.querySelector(".rule-value2");
        operatorSelect.addEventListener("change", () => {
          value2Input.style.display = operatorSelect.value === "between" ? "block" : "none";
        });

        if (ruleData) {
          ruleDiv.querySelector(".rule-operator").value = ruleData.operator || "";
          ruleDiv.querySelector(".rule-value").value = ruleData.value || "";
          if (ruleData.value2) {
            ruleDiv.querySelector(".rule-value2").value = ruleData.value2;
            ruleDiv.querySelector(".rule-value2").style.display = "block";
          }
          if (ruleData.formatId) {
            ruleDiv.querySelector(".rule-format-select").value = ruleData.formatId;
          }
        }
      }

      function deleteColumnRule(ruleId) {
        const ruleElement = document.getElementById(ruleId);
        if (ruleElement) {
          ruleElement.remove();
          console.log(`[v0] Deleted rule element: ${ruleId}`);
        }
      }

      function saveColumnConfig() {
        console.log("[v0] Guardando configuración de columna...");
        
        if (!currentSelectedColumn) {
          console.warn("[v0] No column selected");
          return;
        }

        const rulesContainer = document.getElementById("column-rules-container");
        const conditionalRules = [];
        
        rulesContainer.querySelectorAll(".conditional-rule").forEach((ruleDiv) => {
          const operator = ruleDiv.querySelector(".rule-operator").value;
          const value = ruleDiv.querySelector(".rule-value").value;
          const value2 = ruleDiv.querySelector(".rule-value2").value;
          const formatId = ruleDiv.querySelector(".rule-format-select").value;
          
          if (!formatId) {
            console.warn("[v0] Rule without format, skipping");
            return;
          }

          const rule = {
            operator,
            value,
            formatId // Store reference to format
          };
          
          if (value2) rule.value2 = value2;
          
          conditionalRules.push(rule);
        });

        console.log("[v0] Conditional rules collected:", conditionalRules);

        const columnData = {
          displayName: document.getElementById("column-display-name").value,
          visible: document.getElementById("column-visible").checked,
          includeInExport: document.getElementById("column-export").checked,
          conditionalRules: conditionalRules
        };

        console.log("[v0] Guardando configuración de columna:", currentSelectedColumn, columnData);

        const existingConfigStr = tableau.extensions.settings.get("columnsConfig");
        const columnsConfig = existingConfigStr ? JSON.parse(existingConfigStr) : {};
        
        columnsConfig[currentSelectedColumn] = columnData;
        
        console.log("[v0] Config actualizado:", columnsConfig);

        tableau.extensions.settings.set("columnsConfig", JSON.stringify(columnsConfig));
        
        tableau.extensions.settings.saveAsync().then(() => {
          console.log("[v0] Config guardado exitosamente");
          
          const reloadedStr = tableau.extensions.settings.get("columnsConfig");
          if (reloadedStr) {
            Object.assign(columnsConfig, JSON.parse(reloadedStr));
          }
          console.log("[v0] Config recargado en memoria:", columnsConfig);
          
          // Show confirmation
          const message = document.getElementById("config-saved-message");
          message.classList.add("show");
          setTimeout(() => message.classList.remove("show"), 3000);
        }).catch((error) => {
          console.error("[v0] Error al guardar config:", error);
        });
      }


      function loadFormatosList() {
        console.log('[v0] Loading formats list...');
        const container = document.getElementById('formatos-list-container');
        
        if (Object.keys(savedFormats).length === 0) {
          container.innerHTML = '<div class="empty-state">No hay formatos creados. Haz clic en "Crear Nuevo Formato" para empezar.</div>';
          return;
        }

        container.innerHTML = Object.keys(savedFormats).map(formatId => {
          const format = savedFormats[formatId];
          return generateFormatHTML(formatId, format);
        }).join('');
      }

      function generateFormatHTML(formatId, format) {
        const paintTargetText = format.paintTarget === 'row' ? 'Fila' : format.paintTarget === 'cell' ? 'Celda' : 'Ninguno';
        
        return `
          <div class="conditional-rule" id="${formatId}">
            <div class="rule-header">
              <span class="rule-title">${format.name || 'Sin nombre'}</span>
              <button class="delete-rule-btn" onclick="deleteFormat('${formatId}')">Eliminar</button>
            </div>
            
            <div class="form-group">
              <label>Nombre del formato</label>
              <input type="text" class="format-name" value="${format.name || ''}" placeholder="Ej: Alerta Roja, Éxito Verde">
            </div>
            
            <div class="rule-formatting-row">
              <label>Pintar</label>
              <select class="rule-paint-target">
                <option value="none" ${format.paintTarget === 'none' ? 'selected' : ''}>Ninguno</option>
                <option value="cell" ${format.paintTarget === 'cell' ? 'selected' : ''}>Celda</option>
                <option value="row" ${format.paintTarget === 'row' ? 'selected' : ''}>Fila</option>
              </select>
              
              <label style="margin-left: 12px;">Fondo</label>
              <input type="color" class="rule-bg-color" value="${format.bgColor || '#ffeb3b'}" title="Color de fondo">
              
              <input type="checkbox" class="rule-text-enabled" ${format.textEnabled ? 'checked' : ''} id="${formatId}-text" title="Activar color de texto">
              <label for="${formatId}-text" style="margin: 0;">Texto</label>
              <input type="color" class="rule-text-color" value="${format.textColor || '#000000'}" title="Color de texto">
              
              <input type="checkbox" class="rule-icon-enabled" ${format.iconEnabled ? 'checked' : ''} id="${formatId}-icon" title="Activar ícono" style="margin-left: 12px;">
              <label for="${formatId}-icon" style="margin: 0;">Ícono</label>
              <select class="rule-icon" style="min-width: 80px;">
                <option value="">Ninguno</option>
                <option value="↑" ${format.icon === '↑' ? 'selected' : ''}>↑ Arriba</option>
                <option value="↓" ${format.icon === '↓' ? 'selected' : ''}>↓ Abajo</option>
                <option value="⬤" ${format.icon === '⬤' ? 'selected' : ''}>⬤ Círculo</option>
                <option value="✓" ${format.icon === '✓' ? 'selected' : ''}>✓ Check</option>
                <option value="✗" ${format.icon === '✗' ? 'selected' : ''}>✗ X</option>
                <option value="⚠" ${format.icon === '⚠' ? 'selected' : ''}>⚠ Alerta</option>
                <option value="★" ${format.icon === '★' ? 'selected' : ''}>★ Estrella</option>
                <option value="▲" ${format.icon === '▲' ? 'selected' : ''}>▲ Triángulo</option>
                <option value="🔴" ${format.icon === '🔴' ? 'selected' : ''}>🔴 Rojo</option>
                <option value="🟢" ${format.icon === '🟢' ? 'selected' : ''}>🟢 Verde</option>
                <option value="🟡" ${format.icon === '🟡' ? 'selected' : ''}>🟡 Amarillo</option>
              </select>
              <input type="color" class="rule-icon-color" value="${format.iconColor || '#000000'}" title="Color del ícono">
            </div>
          </div>
        `;
      }

      function addNewFormat() {
        const formatId = `format-${formatCounter++}`;
        const newFormat = {
          name: 'Nuevo Formato',
          paintTarget: 'cell',
          bgColor: '#ffeb3b',
          textEnabled: false,
          textColor: '#000000',
          iconEnabled: false,
          icon: '',
          iconColor: '#000000'
        };
        
        savedFormats[formatId] = newFormat;
        loadFormatosList();
      }

      function deleteFormat(formatId) {
        if (confirm('¿Estás seguro de eliminar este formato? Las reglas que lo usan dejarán de funcionar.')) {
          delete savedFormats[formatId];
          loadFormatosList();
        }
      }

      async function saveFormats() {
        console.log('[v0] Saving formats...');
        
        // Collect all format data from the DOM
        document.querySelectorAll('#formatos-list-container .conditional-rule').forEach(formatDiv => {
          const formatId = formatDiv.id;
          
          savedFormats[formatId] = {
            name: formatDiv.querySelector('.format-name').value,
            paintTarget: formatDiv.querySelector('.rule-paint-target').value,
            bgColor: formatDiv.querySelector('.rule-bg-color').value,
            textEnabled: formatDiv.querySelector('.rule-text-enabled').checked,
            textColor: formatDiv.querySelector('.rule-text-color').value,
            iconEnabled: formatDiv.querySelector('.rule-icon-enabled').checked,
            icon: formatDiv.querySelector('.rule-icon').value,
            iconColor: formatDiv.querySelector('.rule-icon-color').value
          };
        });

        console.log('[v0] Formats to save:', savedFormats);

        // Save to settings
        tableau.extensions.settings.set('savedFormats', JSON.stringify(savedFormats));
        await tableau.extensions.settings.saveAsync();

        // Show confirmation
        const message = document.getElementById('formatos-saved-message');
        message.classList.add('show');
        setTimeout(() => message.classList.remove('show'), 3000);

        console.log('[v0] Formats saved successfully');
      }


      function autoSave() {
        console.log("[v0] === AUTOSAVE INICIADO ===")
        
        try {
          // General settings
          const tableTitle = document.getElementById("table-title").value || "";
          const showSearch = document.getElementById("show-search").checked;
          const showRowCount = document.getElementById("show-row-count").checked;
          
          console.log("[v0] General Settings:");
          console.log("[v0]   - Table Title:", tableTitle);
          console.log("[v0]   - Show Search:", showSearch);
          console.log("[v0]   - Show Row Count:", showRowCount);
          
          tableau.extensions.settings.set("tableTitle", tableTitle);
          tableau.extensions.settings.set("showSearch", showSearch ? "true" : "false");
          tableau.extensions.settings.set("showRowCount", showRowCount ? "true" : "false");
          
          // Export settings
          const exportButtonText = document.getElementById("export-button-text").value || "Exportar";
          const exportFilename = document.getElementById("export-filename").value || "datos";
          const exportButtonColor = document.getElementById("export-button-color").value || "#2563eb";
          const exportButtonTextColor = document.getElementById("export-button-text-color").value || "#ffffff";
          const exportEnableExcel = document.getElementById("export-enable-excel").checked;
          const exportEnableCSV = document.getElementById("export-enable-csv").checked;
          const exportEnablePDF = document.getElementById("export-enable-pdf").checked;
          
          console.log("[v0] Export Settings:");
          console.log("[v0]   - Button Text:", exportButtonText);
          console.log("[v0]   - Filename:", exportFilename);
          console.log("[v0]   - Excel enabled:", exportEnableExcel);
          
          tableau.extensions.settings.set("exportButtonText", exportButtonText);
          tableau.extensions.settings.set("exportFilename", exportFilename);
          tableau.extensions.settings.set("exportButtonColor", exportButtonColor);
          tableau.extensions.settings.set("exportButtonTextColor", exportButtonTextColor);
          tableau.extensions.settings.set("exportEnableExcel", exportEnableExcel ? "true" : "false");
          tableau.extensions.settings.set("exportEnableCSV", exportEnableCSV ? "true" : "false");
          tableau.extensions.settings.set("exportEnablePDF", exportEnablePDF ? "true" : "false");
          
          const currentColumnsConfig = tableau.extensions.settings.get("columnsConfig");
          console.log("[v0] Current columnsConfig in settings:");
          if (currentColumnsConfig) {
            try {
              const parsed = JSON.parse(currentColumnsConfig);
              console.log("[v0]   - Columns:", Object.keys(parsed).length);
              Object.keys(parsed).forEach(colName => {
                if (parsed[colName].conditionalRules && parsed[colName].conditionalRules.length > 0) {
                  console.log(`[v0]   - ${colName}: ${parsed[colName].conditionalRules.length} rules`);
                }
              });
            } catch (e) {
              console.error("[v0] Error parsing columnsConfig:", e);
            }
          } else {
            console.log("[v0]   - No columnsConfig found");
          }
          
          console.log("[v0] All settings prepared, calling saveAsync...")
          return tableau.extensions.settings.saveAsync().then(() => {
            console.log("[v0] ✓ ✓ ✓ SaveAsync completed successfully");
          });
        } catch (error) {
          console.error("[v0] ✗ ✗ ✗ Error in autoSave:", error);
          return Promise.reject(error);
        }
      }

      function saveAndClose() {
        console.log("[v0] === SAVE AND CLOSE INICIADO ===")
        
        if (typeof tableau === 'undefined' || !tableau.extensions) {
          console.error("[v0] ✗ Tableau Extensions not initialized")
          alert("Error: La extensión de Tableau no está inicializada correctamente.")
          return
        }
        
        autoSave()
          .then(() => {
            console.log("[v0] ✓ Settings saved successfully")
            console.log("[v0] Closing dialog with payload: 'saved'")
            tableau.extensions.ui.closeDialog("saved")
          })
          .catch((error) => {
            console.error("[v0] ✗ Error saving settings:", error)
            alert("Error al guardar la configuración: " + error.message)
          })
      }

      function closeDialog() {
        console.log("[v0] CloseDialog called without saving")
        
        if (typeof tableau === 'undefined' || !tableau.extensions) {
          console.error("[v0] Tableau Extensions not initialized")
          window.close()
          return
        }
        
        tableau.extensions.ui.closeDialog("cancelled")
      }

      function populateWorksheetSelector() {
        console.log("[v0] Populating worksheet selector...")
        
        const worksheetSelect = document.getElementById("worksheet-select")
        if (!worksheetSelect) {
          console.error("[v0] Worksheet select element not found")
          return
        }
        
        // Get dashboard from parent window
        if (typeof tableau !== 'undefined' && tableau.extensions && tableau.extensions.dashboardContent) {
          const dashboard = tableau.extensions.dashboardContent.dashboard
          const worksheets = dashboard.worksheets
          
          console.log("[v0] Found worksheets:", worksheets.map(w => w.name))
          
          // Clear existing options except placeholder
          worksheetSelect.innerHTML = '<option value="">La hoja se selecciona desde la extensión</option>'
          
          // Add worksheet options
          worksheets.forEach(ws => {
            const option = document.createElement("option")
            option.value = ws.name
            option.textContent = ws.name
            worksheetSelect.appendChild(option)
          })
          
          // Set current selection
          const currentWorksheet = tableau.extensions.settings.get("worksheet")
          if (currentWorksheet) {
            worksheetSelect.value = currentWorksheet
          }
        } else {
          console.warn("[v0] Tableau dashboard content not available for worksheet selection.")
        }
      }

      // Function to toggle accordion sections
      function toggleSection(element) {
        const sectionHeader = element;
        const sectionContent = sectionHeader.nextElementSibling;
        const sectionToggle = sectionHeader.querySelector('.section-toggle');

        sectionHeader.classList.toggle('collapsed');
        sectionContent.classList.toggle('expanded');
        
        if (sectionContent.classList.contains('expanded')) {
            sectionToggle.textContent = '▼'; // Expanded state
        } else {
            sectionToggle.textContent = '▶'; // Collapsed state
        }
      }

      function saveDesignSettings() {
        console.log('[v0] Saving design settings')
        
        const settings = {
          headerBackgroundColor: document.getElementById('design-header-bg').value,
          headerTextColor: document.getElementById('design-header-text').value,
          headerFont: document.getElementById('design-header-font').value,
          headerFontSize: document.getElementById('design-header-font-size').value,
          bodyFont: document.getElementById('design-body-font').value,
          bodyFontSize: document.getElementById('design-body-font-size').value,
          bodyTextColor: document.getElementById('design-body-text').value,
          rowEvenColor: document.getElementById('design-row-even').value,
          rowOddColor: document.getElementById('design-row-odd').value,
          borderColor: document.getElementById('design-border-color').value,
          borderWidth: document.getElementById('design-border-width').value
        }
        
        Object.entries(settings).forEach(([key, value]) => {
          tableau.extensions.settings.set(key, value)
        })
        
        tableau.extensions.settings.saveAsync().then(() => {
          alert('Configuración de diseño guardada correctamente')
          console.log('[v0] Design settings saved')
        })
      }
      
      function resetDesign() {
        document.getElementById('design-header-bg').value = '#f3f4f6'
        document.getElementById('design-header-text').value = '#111827'
        document.getElementById('design-header-font').value = 'Arial, sans-serif'
        document.getElementById('design-header-font-size').value = '14px'
        document.getElementById('design-body-font').value = 'Arial, sans-serif'
        document.getElementById('design-body-font-size').value = '13px'
        document.getElementById('design-body-text').value = '#374151'
        document.getElementById('design-row-even').value = '#ffffff'
        document.getElementById('design-row-odd').value = '#f9fafb'
        document.getElementById('design-border-color').value = '#e5e7eb'
        document.getElementById('design-border-width').value = '1px'
        
        updateColorDisplays()
      }
      
      function updateColorDisplays() {
        document.getElementById('design-header-bg-value').textContent = document.getElementById('design-header-bg').value
        document.getElementById('design-header-text-value').textContent = document.getElementById('design-header-text').value
        document.getElementById('design-body-text-value').textContent = document.getElementById('design-body-text').value
        document.getElementById('design-row-even-value').textContent = document.getElementById('design-row-even').value
        document.getElementById('design-row-odd-value').textContent = document.getElementById('design-row-odd').value
        document.getElementById('design-border-color-value').textContent = document.getElementById('design-border-color').value
      }
      
      function loadDesignSettings() {
        const settings = tableau.extensions.settings.getAll()
        
        if (settings.headerBackgroundColor) document.getElementById('design-header-bg').value = settings.headerBackgroundColor
        if (settings.headerTextColor) document.getElementById('design-header-text').value = settings.headerTextColor
        if (settings.headerFont) document.getElementById('design-header-font').value = settings.headerFont
        if (settings.headerFontSize) document.getElementById('design-header-font-size').value = settings.headerFontSize
        if (settings.bodyFont) document.getElementById('design-body-font').value = settings.bodyFont
        if (settings.bodyFontSize) document.getElementById('design-body-font-size').value = settings.bodyFontSize
        if (settings.bodyTextColor) document.getElementById('design-body-text').value = settings.bodyTextColor
        if (settings.rowEvenColor) document.getElementById('design-row-even').value = settings.rowEvenColor
        if (settings.rowOddColor) document.getElementById('design-row-odd').value = settings.rowOddColor
        if (settings.borderColor) document.getElementById('design-border-color').value = settings.borderColor
        if (settings.borderWidth) document.getElementById('design-border-width').value = settings.borderWidth
        
        updateColorDisplays()
      }
      
      // Add event listeners for color pickers
      document.addEventListener('DOMContentLoaded', () => {
        const colorInputs = [
          'design-header-bg',
          'design-header-text',
          'design-body-text',
          'design-row-even',
          'design-row-odd',
          'design-border-color'
        ]
        
        colorInputs.forEach(id => {
          const input = document.getElementById(id)
          if (input) {
            input.addEventListener('input', updateColorDisplays)
          }
        })
      })

      // This function should be called once the DOM is ready and Tableau Extensions are initialized.
      // It replaces the direct call to initializeDialogAsync inside DOMContentLoaded.
      async function initializeDialog() {
        console.log("[v0] Inicializando diálogo de configuración")
        try {
          await tableau.extensions.initializeDialogAsync()
          console.log("[v0] Diálogo inicializado")

          const settings = tableau.extensions.settings.getAll()
          console.log("[v0] Settings actuales:", settings)
          
          populateWorksheetSelector()
          
          if (settings.dialogColumns) {
            try {
              const parsed = JSON.parse(settings.dialogColumns)
              // Ensure it's an array
              if (Array.isArray(parsed)) {
                allColumns = parsed
              } else {
                console.warn("[v0] dialogColumns is not an array, resetting to empty array")
                allColumns = []
              }
              console.log("[v0] Loaded columns from settings:", allColumns)
            } catch (e) {
              console.error("[v0] Error parsing dialogColumns:", e)
              allColumns = []
            }
          } else {
            console.warn("[v0] No dialogColumns found in settings")
            allColumns = []
          }
          
          if (settings.columnsConfig) {
            try {
              columnsConfig = JSON.parse(settings.columnsConfig)
              console.log("[v0] Loaded columnsConfig:", columnsConfig)
            } catch (e) {
              console.error("[v0] Error parsing columnsConfig:", e)
              columnsConfig = {}
            }
          }
          
          if (settings.savedFormats) {
            try {
              savedFormats = JSON.parse(settings.savedFormats)
              console.log("[v0] Loaded savedFormats:", savedFormats)
            } catch (e) {
              console.error("[v0] Error parsing savedFormats:", e)
              savedFormats = {}
            }
          }
          
          loadSettings()
          setupEventListeners()
          renderColumnList()
          
          loadDesignSettings()

          console.log("[v0] Inicialización completada")
        } catch (error) {
          console.error("[v0] Error al inicializar:", error)
          alert("Error al inicializar: " + error.message)
        }
      }

      // Removed outdated priority management functions and related HTML comments
    </script>
  </body>
</html>
